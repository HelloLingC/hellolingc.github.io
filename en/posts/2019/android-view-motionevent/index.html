<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android Notes 1 - Analysis of the View Event Distribution Mechanism | MoonLab</title>
<meta name=keywords content="Android"><meta name=description content="Coo Coo Coo
Basically, this article summarizes the chapter on the View event distribution mechanism from the book &ldquo;Exploring Android Art Development.&rdquo;
A long time ago, Android development notes were too superficial.
Brief Introduction
As we all know, an event sequence starts with MotionEvent.ACTION_DOWN (press), followed by multiple MotionEvent.MOVE (move) events, and ends with a MotionEvent.ACTION_UP (release).
The order of event transmission is: Activity -> Window -> DecorView -> RootView (the View you set)."><meta name=author content="LingC"><link rel=canonical href=https://moonlab.top/en/posts/2019/android-view-motionevent/><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]},loader:{load:["ui/safe"]}}</script><link crossorigin=anonymous href=/assets/css/stylesheet.1ff5a7b3bb4a96bf1747dfa25e8031167d4537d7ae4b78fac2b752886047a06e.css rel="preload stylesheet" as=style><link rel=icon href=/moon.svg type=image/svg+xml><link rel=icon type=image/png sizes=16x16 href=https://moonlab.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://moonlab.top/favicon-32x32.png><link rel=apple-touch-icon href=https://moonlab.top/apple-touch-icon.png><link rel=mask-icon href=https://moonlab.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=cn href=https://moonlab.top/posts/2019/android-view-motionevent/><link rel=alternate hreflang=en href=https://moonlab.top/en/posts/2019/android-view-motionevent/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Android Notes 1 - Analysis of the View Event Distribution Mechanism"><meta property="og:description" content="Coo Coo Coo
Basically, this article summarizes the chapter on the View event distribution mechanism from the book &ldquo;Exploring Android Art Development.&rdquo;
A long time ago, Android development notes were too superficial.
Brief Introduction
As we all know, an event sequence starts with MotionEvent.ACTION_DOWN (press), followed by multiple MotionEvent.MOVE (move) events, and ends with a MotionEvent.ACTION_UP (release).
The order of event transmission is: Activity -> Window -> DecorView -> RootView (the View you set)."><meta property="og:type" content="article"><meta property="og:url" content="https://moonlab.top/en/posts/2019/android-view-motionevent/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-14T11:07:50+00:00"><meta property="article:modified_time" content="2019-08-14T11:07:50+00:00"><meta property="og:site_name" content="MoonLab"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android Notes 1 - Analysis of the View Event Distribution Mechanism"><meta name=twitter:description content="Coo Coo Coo
Basically, this article summarizes the chapter on the View event distribution mechanism from the book &ldquo;Exploring Android Art Development.&rdquo;
A long time ago, Android development notes were too superficial.
Brief Introduction
As we all know, an event sequence starts with MotionEvent.ACTION_DOWN (press), followed by multiple MotionEvent.MOVE (move) events, and ends with a MotionEvent.ACTION_UP (release).
The order of event transmission is: Activity -> Window -> DecorView -> RootView (the View you set)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://moonlab.top/en/posts/"},{"@type":"ListItem","position":2,"name":"Android Notes 1 - Analysis of the View Event Distribution Mechanism","item":"https://moonlab.top/en/posts/2019/android-view-motionevent/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android Notes 1 - Analysis of the View Event Distribution Mechanism","name":"Android Notes 1 - Analysis of the View Event Distribution Mechanism","description":"Coo Coo Coo Basically, this article summarizes the chapter on the View event distribution mechanism from the book \u0026ldquo;Exploring Android Art Development.\u0026rdquo;\nA long time ago, Android development notes were too superficial.\nBrief Introduction As we all know, an event sequence starts with MotionEvent.ACTION_DOWN (press), followed by multiple MotionEvent.MOVE (move) events, and ends with a MotionEvent.ACTION_UP (release).\nThe order of event transmission is: Activity -\u0026gt; Window -\u0026gt; DecorView -\u0026gt; RootView (the View you set).\n","keywords":["Android"],"articleBody":"Coo Coo Coo Basically, this article summarizes the chapter on the View event distribution mechanism from the book â€œExploring Android Art Development.â€\nA long time ago, Android development notes were too superficial.\nBrief Introduction As we all know, an event sequence starts with MotionEvent.ACTION_DOWN (press), followed by multiple MotionEvent.MOVE (move) events, and ends with a MotionEvent.ACTION_UP (release).\nThe order of event transmission is: Activity -\u003e Window -\u003e DecorView -\u003e RootView (the View you set).\nViewGroup is a subclass of View, which is fundamental.\nThe event distribution process is mainly accomplished by the following three methods:\npublic boolean dispatchTouchEvent(MotionEvent ev); // This method will definitely be called if the event reaches this View. public boolean onInterceptTouchEvent(MotionEvent event); // Used to determine whether the View intercepts this event. If intercepted, this method will not be called again in this event sequence. public boolean onTouchEvent(MotionEvent event); // Used to handle the event, returning whether the current event is consumed. If not consumed, this View will not receive it again in the same event sequence. Below is a piece of pseudocode to illustrate the relationship between the three methods:\npublic boolean dispatchTouchEvent(MotionEvent ev) { boolean consume = false; // onInterceptTouchEvent determines whether to intercept this event if (onInterceptTouchEvent(ev)) { // If intercepted, call onTouchEvent to handle the event and return whether this event is consumed consume = onTouchEvent(ev); } else { // If not intercepted, pass it to the child View consume = child.dispatchTouchEvent(ev); } // The return value of this method indicates whether this event is intercepted. return consume; } æ³¨æ„è°ƒç”¨ dispatchTouchEvent æ—¶å¾€å¾€ç¬¬ä¸€ä¸ªæ˜¯ ACTION_DOWN äº‹ä»¶ï¼Œè¯·ææ¸…â€œæ‹¦æˆªâ€å’Œâ€œæ¶ˆè€—â€ä¸¤ä¸ªæ¦‚å¿µï¼ŒonInterceptTouchEvent è¿”å›çš„æ˜¯æ˜¯å¦æ‹¦æˆªï¼ŒonTouchEvent è¿”å›çš„æ˜¯æ˜¯å¦æ¶ˆè€—ã€‚\nå¦‚æœ onInterceptTouchEvent è¿”å› true ï¼Œä½† onTouchEvent è¿”å› falseï¼Œå³ä»£è¡¨æ‹¦æˆªä½†ä¸æ¶ˆè€—äº‹ä»¶ï¼Œå¦‚æœè¿™ä¸ªäº‹ä»¶æ˜¯ ACTION_DOWNï¼Œé‚£ä¹ˆåŒä¸€äº‹ä»¶åºåˆ—çš„å…¶ä»–äº‹ä»¶å°†ä¸ä¼šå†äº¤ç»™æ­¤ View äº†ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ä¸Šä¸€çº§çš„ onTouchEventï¼Œå¦‚æœè¿˜æ˜¯ false ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ä¸Šä¸€çº§çš„ä¸Šä¸€çº§çš„ onTouchEventï¼Œå¦‚æœéƒ½æ˜¯ falseï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šäº¤ç»™ Activity å¤„ç†ã€‚\nonTouchEvent çš„è¿”å›å€¼æ˜¯å–å†³äº View çš„ clickable å’Œ longClickable å±æ€§çš„ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªä¸º trueï¼Œé‚£ä¹ˆ onTouchEvent å°±ä¼šè¿”å› trueï¼Œä¸ enable å±æ€§æ— å…³ã€‚\nå¦‚æœ View ä¸æ¶ˆè€—é™¤ ACTION_DOWN ä»¥å¤–çš„äº‹ä»¶ï¼Œé‚£ä¹ˆçˆ¶ View çš„ onTouchEvent ä¸ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ­¤ View ä»ç„¶å¯ä»¥æ¥æ”¶åˆ°äº‹ä»¶ï¼Œä¸æ¶ˆè€—çš„äº‹ä»¶å°†ç›´æ¥äº¤ç»™ Activity å¤„ç†ã€‚\nAndroid æºç ä¸­ ViewGroup çš„ onInterceptTouchEvent é»˜è®¤ä¼šè¿”å› falseï¼Œè€Œ View åˆ™æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä¼šç›´æ¥è°ƒç”¨ onTouchEventã€‚\nå¦‚æœä¸€ä¸ª View è®¾ç½®äº† OnTouchListener é‚£ä¹ˆé‡Œé¢çš„ onTouch æ–¹æ³•åˆ™ä¼šè¢«å›è°ƒï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ onTouch ä¼šè¿”å›ä¸€ä¸ª boolean ï¼ŒonTouchEvent æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨æ˜¯å–å†³äºè¿™ä¸ª boolean çš„ï¼Œå¦‚æœè¿”å› falseï¼Œé‚£ä¹ˆ onTouchEvent åˆ™ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬ç»å¸¸è®¾ç½®çš„ OnClickListener æ˜¯åœ¨ onTouchEvent ä¸­çš„ã€‚\nä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ onTouchListener çš„ä¼˜å…ˆçº§é«˜äº onTouchEventï¼Œè€Œ OnClickListener åˆ™æ˜¯ä¼˜å…ˆçº§æœ€ä½çš„ã€‚\nåœ¨ç½‘ä¸Šç¿»åˆ°äº†ä¸€å¼ å›¾ï¼Œæ€»ç»“å¾—æŒºå¥½ï¼šhttps://upload-images.jianshu.io/upload_images/2435754-a09ab44cb25be80d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/972/format/webp\nAndroid æºç åˆ†æ äº‹ä»¶æœ€å¼€å§‹ä¼šè°ƒç”¨åˆ° Activity çš„ dispatchTouchEvent æ–¹æ³•ï¼š\npublic boolean dispatchTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { onUserInteraction(); } if (getWindow().superDispatchTouchEvent(ev)) { return true; } return onTouchEvent(ev); } äº‹ä»¶å¼€å§‹äº¤ç»™ Activity æ‰€å±çš„ Window è¿›è¡Œåˆ†å‘ï¼ŒWindow çš„å®ç°ç±»æ˜¯ PhoneWindow ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ PhoneWindow#superDispatchTouchEventï¼š\nprivate DecorView mDecor; @Override public boolean superDispatchTouchEvent(MotionEvent event) { return mDecor.superDispatchTouchEvent(event); } å¾ˆæ˜æ˜¾ï¼ŒWindow åˆæŠŠäº‹ä»¶äº¤ç»™äº† DecorView ï¼Œå°±æ˜¯ä½ æ‰€è®¾ç½®çš„å¸ƒå±€çš„çˆ¶ Viewã€‚\nDecorView#superDispatchTouchEvent\npublic boolean superDispatchTouchEvent(MotionEvent event) { // è¿™é‡Œåˆå°†äº‹ä»¶ä¼ åˆ°äº† ViewGroup, DecorView æ˜¯ç»§æ‰¿è‡ª ViewGroup çš„ return super.dispatchTouchEvent(event); } æˆ‘ä»¬æ‰€è®¾ç½®çš„ View ç§°ä½œä¸ºæ ¹ View æˆ– é¡¶çº§ Viewã€‚\nè‡³æ­¤ï¼Œäº‹ä»¶å·²ç»ä¼ é€’åˆ°æˆ‘ä»¬çš„ View ä¸­äº†ã€‚\nViewGroup æºç è§£æ æˆ‘ä»¬æ¥çœ‹çœ‹ ViewGroup ä¸­çš„ dispatchTouchEvent æ–¹æ³•çš„ä¸€å°æ®µï¼Œå› ä¸º Android æºç å®åœ¨è¿‡äºå¤æ‚ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨æˆ‘ä»¬éœ€è¦ä¸“æ³¨çš„å†…å®¹å°±å¥½ã€‚\n// è¿™ä¸ªåœ°æ–¹æ˜¯ ViewGroup æ˜¯å¦æ‹¦æˆªäº‹ä»¶çš„ä¸€ä¸ªé€»è¾‘ final boolean intercepted; if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { // å½“ ViewGroup æ»¡è¶³ actionMasked == MotionEvent.ACTION_DOWN æˆ– mFirstTouchTarget != null ä¸”æ²¡æœ‰è®¾ç½®æ ‡è®°ä½å°±ä¼šè°ƒç”¨onInterceptTouchEvent // FLAG_DISALLOW_INTERCEPT æ ‡è®°ä½æ˜¯ç”± requestDisallowInterceptTouchEvent æ–¹æ³•è®¾ç½®çš„ final boolean disallowIntercept = (mGroupFlags \u0026 FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { // onInterceptTouchEvent æ–¹æ³•åœ¨è¿™ intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; } } else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true; } è¿™ä¸ª actionMasked == MotionEvent.ACTION_DOWN ä¸ç”¨å¤šè¯´ï¼Œå¦‚æœäº‹ä»¶ç”± ViewGroup æ‹¦æˆªçš„è¯ï¼Œé‚£ä¹ˆåé¢çš„ mFirstTouchTarget != null ä¸­çš„ mFirstTouchTarget æ˜¯æŒ‡å‘å­å…ƒç´ çš„ï¼Œä¸€æ—¦äº‹ä»¶ç”± ViewGroup æ‹¦æˆªï¼Œé‚£ä¹ˆåé¢çš„ ACTION_MOVE, ACTION_UP ç»è¿‡è¿™é‡Œæ—¶ï¼Œ (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) ä¼šè¿”å› falseï¼Œæ‰€ä»¥ ViewGroup çš„ onInterceptTouchEvent ä¸ä¼šå†è¢«è°ƒç”¨ï¼Œä¸”åŒä¸€äº‹ä»¶åºåˆ—çš„å…¶ä»–äº‹ä»¶éƒ½äº¤ç”±å®ƒå¤„ç†ã€‚\nå¦‚æœ ViewGroup ä¸æ‹¦æˆªï¼Œé‚£ä¹ˆ mFirstTouchTarget ä¼šæŒ‡å‘å­å…ƒç´ ï¼ŒmFirstTouchTarget != null ä¸º trueï¼Œåˆ™ä¼šè°ƒç”¨ onInterceptTouchEvent ï¼Œæ˜¾è€Œæ˜“è§ä¸æ˜¯å—ï¼Ÿ\næˆ‘ä»¬å¯ä»¥ä»”ç»†æƒ³æƒ³ï¼Œç¬¬ä¸€ä¸ªä¼ é€’åˆ°è¿™é‡Œçš„äº‹ä»¶ç»å¸¸æ˜¯ ACTION_DOWNï¼Œå¦‚æœæ‹¦æˆªé‚£ä¹ˆåç»­çš„åŒä¸€äº‹ä»¶åºåˆ—ä¸­çš„å…¶ä»–äº‹ä»¶éƒ½ä¼šäº¤ç»™å®ƒå¤„ç†ï¼Œè¿™æ—¶å€™ onInterceptTouchEvent è¢«è°ƒç”¨ã€‚\nå‡å¦‚åé¢åˆæ¥äº†ä¸ª ACTION_MOVEï¼Œè¿™æ—¶å€™å› ä¸º (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) ä¸º false ä¼šç›´æ¥æ‹¦æˆªï¼Œä½†ä¸ä¼šè°ƒç”¨ onInterceptTouchEvent äº†ã€‚\nè¿™å°±è¯æ˜äº†ï¼šå¦‚æœä¸€ä¸ª View ä¸€æ—¦å†³å®šæ‹¦æˆªï¼Œé‚£ä¹ˆå°†ä¸å†è°ƒç”¨ onInterceptTouchEvent æ¥è¯¢é—®æ˜¯å¦æ‹¦æˆªã€‚\nä½ ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåä¸º FLAG_DISALLOW_INTERCEPT çš„æ ‡è®°ä½ï¼Œå¦‚æœå­ View è®¾ç½®äº†è¿™ä¸ªæ ‡è®°ä½ï¼Œé‚£ä¹ˆ\n(!disallowIntercept) è¡¨è¾¾å¼åˆ™ä¸º falseï¼Œçˆ¶ View åˆ™ä¸ä¼šæ‹¦æˆªæ­¤äº‹ä»¶ï¼Œå½“ç„¶ ACTION_DOWN äº‹ä»¶é™¤å¤–ï¼Œå› ä¸º View åˆ¤æ–­å¦‚æœæ˜¯ ACTION_DOWN åˆ™ä¼šé‡ç½®è¿™ä¸ªæ ‡è®°ä½ã€‚\næ ‡è®°ä½é‡ç½®ä»£ç ï¼š\n// Handle an initial down. if (actionMasked == MotionEvent.ACTION_DOWN) { // Throw away all previous state when starting a new touch gesture. // The framework may have dropped the up or cancel event for the previous gesture // due to an app switch, ANR, or some other state change. cancelAndClearTouchTargets(ev); resetTouchState(); } æˆ‘ä»¬å†çœ‹ ViewGroup ä¸æ‹¦æˆªçš„æ—¶å€™ï¼š\nfinal int childrenCount = mChildrenCount; if (newTouchTarget == null \u0026\u0026 childrenCount != 0) { final float x = ev.getX(actionIndex); final float y = ev.getY(actionIndex); final ArrayList\u003cView\u003e preorderedList = buildTouchDispatchChildList(); final boolean customOrder = preorderedList == null \u0026\u0026 isChildrenDrawingOrderEnabled(); final View[] children = mChildren; for (int i = childrenCount - 1; i \u003e= 0; i--) { final int childIndex = getAndVerifyPreorderedIndex( childrenCount, i, customOrder); // child final View child = getAndVerifyPreorderedView( preorderedList, children, childIndex); if (childWithAccessibilityFocus != null) { if (childWithAccessibilityFocus != child) { continue; } childWithAccessibilityFocus = null; i = childrenCount - 1; } if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue; } newTouchTarget = getTouchTarget(child); if (newTouchTarget != null) { newTouchTarget.pointerIdBits |= idBitsToAssign; break; } resetCancelNextUpFlag(child); // dispatchTransformedTouchEvent åˆ™æ˜¯è°ƒç”¨å­å…ƒç´ çš„ dispatchTouchEvent if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { mLastTouchDownTime = ev.getDownTime(); if (preorderedList != null) { // childIndex points into presorted list, find original index for (int j = 0; j \u003c childrenCount; j++) { if (children[childIndex] == mChildren[j]) { mLastTouchDownIndex = j; break; } } } else { mLastTouchDownIndex = childIndex; } mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; break; } ev.setTargetAccessibilityFocus(false); } if (preorderedList != null) preorderedList.clear(); } ç®€å•è¯´ä¸€å§ï¼ŒdispatchTransformedTouchEvent åˆ™æ˜¯è°ƒç”¨å­å…ƒç´ çš„ dispatchTouchEventï¼ŒåŒæ¥å‘å­View åˆ†å‘äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹ dispatchTransformedTouchEvent æ–¹æ³•å†…å®¹ï¼š\nfinal int oldAction = event.getAction(); if (cancel || oldAction == MotionEvent.ACTION_CANCEL) { event.setAction(MotionEvent.ACTION_CANCEL); if (child == null) { // å› ä¸º ViewGroup extends View ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ View çš„ dispatchTouchEvent æ–¹æ³• handled = super.dispatchTouchEvent(event); } else { // è°ƒç”¨å­ç±»çš„ dispatchTouchEvent handled = child.dispatchTouchEvent(event); } event.setAction(oldAction); // è¿”å›å­ View æ˜¯å¦æ‹¦æˆª return handled; } å¦‚æœ dispatchTransformedTouchEvent ä¸º trueï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ addTouchTarget æ–¹æ³•ä¸º mFirstTouchTarget èµ‹å€¼\nnewTouchTarget = addTouchTarget(child, idBitsToAssign); // å…·ä½“ addTouchTarget é‡Œçš„ä»£ç å°±ä¸çœ‹äº† alreadyDispatchedToNewTouchTarget = true; å¦‚æœæœ€åéå†æ‰€æœ‰å­å…ƒç´ äº‹ä»¶å´æ²¡æœ‰è¢«åˆé€‚çš„å¤„ç†ï¼Œè¦ä¹ˆæ˜¯ ViewGroup å†…æ²¡æœ‰åˆé€‚çš„å¯ä¼ é€’ Viewï¼Œè¦ä¹ˆæ˜¯å­ View æ‹¦æˆªå¹¶å¤„ç†äº†äº‹ä»¶ï¼Œä½† onTouchEvent è¿”å›äº† falseï¼Œæ‰€ä»¥ dispatchTouchEvent ä¹Ÿè¿”å›äº† falseã€‚\nè¿™æ—¶ ViewGroup å°±è¦è‡ªå·±å¤„ç†äº‹ä»¶äº†ï¼ˆéœ‡æƒŠï¼å­¤å¯¡è€äººç«Ÿæ— å­å¯ç”¨ï¼è¿™ç©¶ç«Ÿæ˜¯â€¦ï¼‰ï¼š\n// Dispatch to touch targets. if (mFirstTouchTarget == null) { // No touch targets so treat this as an ordinary view. handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS) } è°ƒç”¨äº† dispatchTransformedTouchEven å¹¶åœ¨å‚æ•° child ä¼ å…¥äº† nullï¼Œå›é¡¾æˆ‘ä»¬ä¸Šé¢è´´å‡ºæ¥çš„ dispatchTransformedTouchEven æ–¹æ³•çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœä¸º child == nullåˆ™ä¼šè°ƒç”¨ ViewGroup è‡ªå·±çš„ dispatchTouchEventã€‚\nViewGroup çš„æºç è§£æåˆ°æ­¤ä¹Ÿå·®ä¸å¤šäº†ã€‚\nView æºç è§£æ æ¥ç€çœ‹å®ƒçš„ä¸€æ®µ dispatchTouchEvent ä»£ç ï¼š\npublic boolean dispatchTouchEvent(MotionEvent event) { boolean result = false; ... if (onFilterTouchEventForSecurity(event)) { if ((mViewFlags \u0026 ENABLED_MASK) == ENABLED \u0026\u0026 handleScrollBarDragging(event)) { result = true; } ListenerInfo li = mListenerInfo; if (li != null \u0026\u0026 li.mOnTouchListener != null \u0026\u0026 (mViewFlags \u0026 ENABLED_MASK) == ENABLED \u0026\u0026 li.mOnTouchListener.onTouch(this, event)) { result = true; } if (!result \u0026\u0026 onTouchEvent(event)) { result = true; } } ... return result; } è¿™é‡Œçš„ View åªå¤„ç†è‡ªå·±çš„äº‹ä»¶ï¼Œä¸ä¼šå†å‘ä¸‹ä¼ é€’äº‹ä»¶äº†ã€‚\næˆ‘ä»¬çœ‹å‘ä¸­é—´ç¬¬äºŒä¸ª if ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœè®¾ç½®äº† OnTouchListenerï¼Œä¸” onTouch æ–¹æ³•è¿”å›äº† trueï¼Œé‚£ä¹ˆ onTouchEvent å°±ä¸ä¼šæ‰§è¡Œï¼Œè¯æ˜äº†å‰é¢æ‰€è¯´çš„ OnTouchListener ä¼˜å…ˆçº§é«˜äº OnClickListenerã€‚\næˆ‘ä»¬å†çœ‹ onTouchEvent çš„ä»£ç ï¼š\nif ((viewFlags \u0026 ENABLED_MASK) == DISABLED) { if (action == MotionEvent.ACTION_UP \u0026\u0026 (mPrivateFlags \u0026 PFLAG_PRESSED) != 0) { setPressed(false); } return (((viewFlags \u0026 CLICKABLE) == CLICKABLE || (viewFlags \u0026 LONG_CLICKABLE) == LONG_CLICKABLE) || (viewFlags \u0026 CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE); } å³ä½¿ View ä¸º disabled çŠ¶æ€ä¹Ÿèƒ½æ¶ˆè€—äº‹ä»¶ã€‚\nif (((viewFlags \u0026 CLICKABLE) == CLICKABLE || (viewFlags \u0026 LONG_CLICKABLE) == LONG_CLICKABLE) || (viewFlags \u0026 CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) { // åªè¦ clickable | longClickable å…¶ä¸­ä¸€ä¸ªä¸º true å°±èƒ½æ‰§è¡Œè¿™é‡Œï¼ŒonTouchEvent å°±ä¼šè¿”å› true switch (action) { case MotionEvent.ACTION_UP: // å½“æ‰‹æŒ‡æŠ¬èµ·æ—¶ boolean prepressed = (mPrivateFlags \u0026 PFLAG_PREPRESSED) != 0; if ((mPrivateFlags \u0026 PFLAG_PRESSED) != 0 || prepressed) { ... if (!mHasPerformedLongPress \u0026\u0026 !mIgnoreNextUpEvent) { removeLongPressCallback(); if (!focusTaken) { if (mPerformClick == null) { mPerformClick = new PerformClick(); } if (!post(mPerformClick)) { // performClick å°†ä¼šè°ƒç”¨ onClick performClick(); } } } ... } break; ... } ... return true; } æˆ‘ä»¬æ¥ç€çœ‹ performClick æ–¹æ³•\npublic boolean performClick() { final boolean result; final ListenerInfo li = mListenerInfo; if (li != null \u0026\u0026 li.mOnClickListener != null) { // ç‚¹å‡»éŸ³ playSoundEffect(SoundEffectConstants.CLICK); // onClick åœ¨è¿™ li.mOnClickListener.onClick(this); result = true; } else { result = false; } sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED); return result; } è¿˜æ²¡ç»“æŸï¼Œæˆ‘ä»¬å†çœ‹ä¸€çœ‹ setOnClickListener æ–¹æ³•\npublic void setOnClickListener(OnClickListener l) { if (!isClickable) { setClickable(true); } getListenerInfo.mOnClickListener = l; } å¯ä»¥çœ‹åˆ°åœ¨è®¾ç½® View çš„ OnClickListenerä¼šè‡ªåŠ¨æ”¹å˜ View çš„ clickable å±æ€§ï¼Œè€Œ setOnLongClickListener ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\næ€»ç»“ äº‹ä»¶åˆ†å‘æœºåˆ¶å°±æ˜¯ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘ï¼Œåœ¨æ‰‹æŒ‡æ¥è§¦å±å¹•åäº§ç”Ÿçš„åŒä¸€ä¸ªäº‹ä»¶åºåˆ—éƒ½æ˜¯ç‚¹å‡»äº‹ä»¶ã€‚ ç‚¹å‡»äº‹ä»¶çš„ä¼ é€’é¡ºåºæ˜¯ç”±å¤–å‘å†…ã€‚ æ­£å¸¸æƒ…å†µä¸‹ä¸€ä¸ªäº‹ä»¶åºåˆ—åªèƒ½è¢«ä¸€ä¸ª View æ‹¦æˆªä¸”æ¶ˆè€—ã€‚ å¦‚æœ View å†³å®šæ‹¦æˆªäº‹ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ªäº‹ä»¶åºåˆ—éƒ½ä¼šç”±è¿™ä¸ªViewæ¥å¤„ç†ã€‚ å½“å­ View æ‹¦æˆªå´ä¸ä¸æ¶ˆè€—ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ç‚¹å‡»äº‹ä»¶å°†äº¤ç”±ç»™ä»–çš„çˆ¶Viewå»å¤„ç†ï¼Œå¦‚æœæ‰€æœ‰çš„ View éƒ½æ²¡æœ‰æ¶ˆè€—æ‰ç‚¹å‡»äº‹ä»¶ï¼ˆonTouchEvent è¿”å› falseï¼‰ï¼Œæœ€ç»ˆ Activity ä¼šè°ƒç”¨è‡ªå·±çš„ onTouchEventã€‚ onInterceptTouchEvent æ–¹æ³•ä¸ä¸€å®šä¼šæ¯æ¬¡éƒ½æ‰§è¡Œï¼Œä¸€ä¸ª View ä¸€æ—¦å†³å®šæ‹¦æˆªå°†ä¸ä¼šè°ƒç”¨ onInterceptTouchEvent OnTouchListenerçš„ä¼˜å…ˆçº§é«˜äºonTouchEvent()ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯æ–¹ä¾¿åœ¨å¤–éƒ¨å¤„ç†äº‹ä»¶ã€‚ å½“æˆ‘ä»¬æŠŠ View è®¾ç½®ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼ŒView ä¾ç„¶ä¼šæ¶ˆè€—äº‹ä»¶ã€‚ ","wordCount":"1327","inLanguage":"en","datePublished":"2019-08-14T11:07:50Z","dateModified":"2019-08-14T11:07:50Z","author":{"@type":"Person","name":"LingC"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moonlab.top/en/posts/2019/android-view-motionevent/"},"publisher":{"@type":"Organization","name":"MoonLab","logo":{"@type":"ImageObject","url":"https://moonlab.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://moonlab.top/en/ accesskey=h title="MoonLab (Alt + H)"><img src=/moon.svg alt aria-label=logo height=20>MoonLab</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://moonlab.top/ title=ç®€ä½“ä¸­æ–‡ aria-label=ç®€ä½“ä¸­æ–‡>Cn</a></li></ul></div></div><ul id=menu><li><a href=https://moonlab.top/en/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://moonlab.top/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://moonlab.top/en/about/ title=About><span>About</span></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=Travel><span>Travel</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><div class=body-layout><div class=leftbar></div><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Android Notes 1 - Analysis of the View Event Distribution Mechanism</h1><div class=post-meta><span title='2019-08-14 11:07:50 +0000 UTC'>August 14, 2019</span>&nbsp;Â·&nbsp;LingC&nbsp;|&nbsp;Read in other languages:<ul class=i18n_list><li><a href=https://moonlab.top/posts/2019/android-view-motionevent/>ç®€ä½“ä¸­æ–‡ğŸ‡¨ğŸ‡³</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#coo-coo-coo aria-label="Coo Coo Coo">Coo Coo Coo</a></li><li><a href=#brief-introduction aria-label="Brief Introduction">Brief Introduction</a></li><li><a href=#android-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="Android æºç åˆ†æ">Android æºç åˆ†æ</a><ul><li><a href=#viewgroup-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90 aria-label="ViewGroup æºç è§£æ">ViewGroup æºç è§£æ</a></li><li><a href=#view-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90 aria-label="View æºç è§£æ">View æºç è§£æ</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li></ul></div></details></div><div class=post-summary><span class=bold-text>ğŸ–Šï¸ AI Translation</span><br><span class=post-summary-main>This article was translated by AI.
&nbsp;<a class=primary-link href=https://moonlab.top/posts/2019/android-view-motionevent/>View original</a></span></div><div class=post-content><h1 id=coo-coo-coo>Coo Coo Coo<a hidden class=anchor aria-hidden=true href=#coo-coo-coo>#</a></h1><p>Basically, this article summarizes the chapter on the View event distribution mechanism from the book &ldquo;Exploring Android Art Development.&rdquo;</p><p>A long time ago, Android development notes were too superficial.</p><h1 id=brief-introduction>Brief Introduction<a hidden class=anchor aria-hidden=true href=#brief-introduction>#</a></h1><p>As we all know, an event sequence starts with MotionEvent.ACTION_DOWN (press), followed by multiple MotionEvent.MOVE (move) events, and ends with a MotionEvent.ACTION_UP (release).</p><p>The order of event transmission is: Activity -> Window -> DecorView -> RootView (the View you set).</p><p>ViewGroup is a subclass of View, which is fundamental.</p><p>The event distribution process is mainly accomplished by the following three methods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span>(MotionEvent ev);
</span></span><span style=display:flex><span><span style=color:#75715e>// This method will definitely be called if the event reaches this View.</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onInterceptTouchEvent</span>(MotionEvent event);
</span></span><span style=display:flex><span><span style=color:#75715e>// Used to determine whether the View intercepts this event. If intercepted, this method will not be called again in this event sequence.</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTouchEvent</span>(MotionEvent event);
</span></span><span style=display:flex><span><span style=color:#75715e>// Used to handle the event, returning whether the current event is consumed. If not consumed, this View will not receive it again in the same event sequence.</span>
</span></span></code></pre></div><p>Below is a piece of pseudocode to illustrate the relationship between the three methods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span>(MotionEvent ev) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> consume <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// onInterceptTouchEvent determines whether to intercept this event</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (onInterceptTouchEvent(ev)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If intercepted, call onTouchEvent to handle the event and return whether this event is consumed</span>
</span></span><span style=display:flex><span>        consume <span style=color:#f92672>=</span> onTouchEvent(ev);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If not intercepted, pass it to the child View</span>
</span></span><span style=display:flex><span>        consume <span style=color:#f92672>=</span> child.<span style=color:#a6e22e>dispatchTouchEvent</span>(ev);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The return value of this method indicates whether this event is intercepted.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> consume;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„è°ƒç”¨ dispatchTouchEvent æ—¶å¾€å¾€ç¬¬ä¸€ä¸ªæ˜¯ ACTION_DOWN äº‹ä»¶ï¼Œè¯·ææ¸…â€œæ‹¦æˆªâ€å’Œâ€œæ¶ˆè€—â€ä¸¤ä¸ªæ¦‚å¿µï¼ŒonInterceptTouchEvent è¿”å›çš„æ˜¯æ˜¯å¦æ‹¦æˆªï¼ŒonTouchEvent è¿”å›çš„æ˜¯æ˜¯å¦æ¶ˆè€—ã€‚</p><p>å¦‚æœ onInterceptTouchEvent è¿”å› true ï¼Œä½† onTouchEvent è¿”å› falseï¼Œå³ä»£è¡¨æ‹¦æˆªä½†ä¸æ¶ˆè€—äº‹ä»¶ï¼Œå¦‚æœè¿™ä¸ªäº‹ä»¶æ˜¯ ACTION_DOWNï¼Œé‚£ä¹ˆåŒä¸€äº‹ä»¶åºåˆ—çš„å…¶ä»–äº‹ä»¶å°†ä¸ä¼šå†äº¤ç»™æ­¤ View äº†ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ä¸Šä¸€çº§çš„ onTouchEventï¼Œå¦‚æœè¿˜æ˜¯ false ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ä¸Šä¸€çº§çš„ä¸Šä¸€çº§çš„ onTouchEventï¼Œå¦‚æœéƒ½æ˜¯ falseï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šäº¤ç»™ Activity å¤„ç†ã€‚</p><p>onTouchEvent çš„è¿”å›å€¼æ˜¯å–å†³äº View çš„ clickable å’Œ longClickable å±æ€§çš„ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªä¸º trueï¼Œé‚£ä¹ˆ onTouchEvent å°±ä¼šè¿”å› trueï¼Œä¸ enable å±æ€§æ— å…³ã€‚</p><p>å¦‚æœ View ä¸æ¶ˆè€—é™¤ ACTION_DOWN ä»¥å¤–çš„äº‹ä»¶ï¼Œé‚£ä¹ˆçˆ¶ View çš„ onTouchEvent ä¸ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ­¤ View ä»ç„¶å¯ä»¥æ¥æ”¶åˆ°äº‹ä»¶ï¼Œä¸æ¶ˆè€—çš„äº‹ä»¶å°†ç›´æ¥äº¤ç»™ Activity å¤„ç†ã€‚</p><p>Android æºç ä¸­ ViewGroup çš„ onInterceptTouchEvent é»˜è®¤ä¼šè¿”å› falseï¼Œè€Œ View åˆ™æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä¼šç›´æ¥è°ƒç”¨ onTouchEventã€‚</p><p>å¦‚æœä¸€ä¸ª View è®¾ç½®äº† OnTouchListener é‚£ä¹ˆé‡Œé¢çš„ onTouch æ–¹æ³•åˆ™ä¼šè¢«å›è°ƒï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ onTouch ä¼šè¿”å›ä¸€ä¸ª boolean ï¼ŒonTouchEvent æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨æ˜¯å–å†³äºè¿™ä¸ª boolean çš„ï¼Œå¦‚æœè¿”å› falseï¼Œé‚£ä¹ˆ onTouchEvent åˆ™ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬ç»å¸¸è®¾ç½®çš„ OnClickListener æ˜¯åœ¨ onTouchEvent ä¸­çš„ã€‚</p><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ onTouchListener çš„ä¼˜å…ˆçº§é«˜äº onTouchEventï¼Œè€Œ OnClickListener åˆ™æ˜¯ä¼˜å…ˆçº§æœ€ä½çš„ã€‚</p><p>åœ¨ç½‘ä¸Šç¿»åˆ°äº†ä¸€å¼ å›¾ï¼Œæ€»ç»“å¾—æŒºå¥½ï¼šhttps://upload-images.jianshu.io/upload_images/2435754-a09ab44cb25be80d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/972/format/webp</p><h1 id=android-æºç åˆ†æ>Android æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#android-æºç åˆ†æ>#</a></h1><p>äº‹ä»¶æœ€å¼€å§‹ä¼šè°ƒç”¨åˆ° Activity çš„ dispatchTouchEvent æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span>(MotionEvent ev) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ev.<span style=color:#a6e22e>getAction</span>() <span style=color:#f92672>==</span> MotionEvent.<span style=color:#a6e22e>ACTION_DOWN</span>) {
</span></span><span style=display:flex><span>            onUserInteraction();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (getWindow().<span style=color:#a6e22e>superDispatchTouchEvent</span>(ev)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> onTouchEvent(ev);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>äº‹ä»¶å¼€å§‹äº¤ç»™ Activity æ‰€å±çš„ Window è¿›è¡Œåˆ†å‘ï¼ŒWindow çš„å®ç°ç±»æ˜¯ PhoneWindow ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ PhoneWindow#superDispatchTouchEventï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> DecorView mDecor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>superDispatchTouchEvent</span>(MotionEvent event) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mDecor.<span style=color:#a6e22e>superDispatchTouchEvent</span>(event);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¾ˆæ˜æ˜¾ï¼ŒWindow åˆæŠŠäº‹ä»¶äº¤ç»™äº† DecorView ï¼Œå°±æ˜¯ä½ æ‰€è®¾ç½®çš„å¸ƒå±€çš„çˆ¶ Viewã€‚</p><p>DecorView#superDispatchTouchEvent</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>superDispatchTouchEvent</span>(MotionEvent event) {
</span></span><span style=display:flex><span>     <span style=color:#75715e>// è¿™é‡Œåˆå°†äº‹ä»¶ä¼ åˆ°äº† ViewGroup, DecorView æ˜¯ç»§æ‰¿è‡ª ViewGroup çš„</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>dispatchTouchEvent</span>(event);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬æ‰€è®¾ç½®çš„ View ç§°ä½œä¸ºæ ¹ View æˆ– é¡¶çº§ Viewã€‚</p><p>è‡³æ­¤ï¼Œäº‹ä»¶å·²ç»ä¼ é€’åˆ°æˆ‘ä»¬çš„ View ä¸­äº†ã€‚</p><h2 id=viewgroup-æºç è§£æ>ViewGroup æºç è§£æ<a hidden class=anchor aria-hidden=true href=#viewgroup-æºç è§£æ>#</a></h2><p>æˆ‘ä»¬æ¥çœ‹çœ‹ ViewGroup ä¸­çš„ dispatchTouchEvent æ–¹æ³•çš„ä¸€å°æ®µï¼Œå› ä¸º Android æºç å®åœ¨è¿‡äºå¤æ‚ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨æˆ‘ä»¬éœ€è¦ä¸“æ³¨çš„å†…å®¹å°±å¥½ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// è¿™ä¸ªåœ°æ–¹æ˜¯ ViewGroup æ˜¯å¦æ‹¦æˆªäº‹ä»¶çš„ä¸€ä¸ªé€»è¾‘</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> intercepted;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (actionMasked <span style=color:#f92672>==</span> MotionEvent.<span style=color:#a6e22e>ACTION_DOWN</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>||</span> mFirstTouchTarget <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// å½“ ViewGroup æ»¡è¶³ actionMasked == MotionEvent.ACTION_DOWN æˆ– mFirstTouchTarget != null ä¸”æ²¡æœ‰è®¾ç½®æ ‡è®°ä½å°±ä¼šè°ƒç”¨onInterceptTouchEvent</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// FLAG_DISALLOW_INTERCEPT æ ‡è®°ä½æ˜¯ç”± requestDisallowInterceptTouchEvent æ–¹æ³•è®¾ç½®çš„</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> disallowIntercept <span style=color:#f92672>=</span> (mGroupFlags <span style=color:#f92672>&amp;</span> FLAG_DISALLOW_INTERCEPT) <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>disallowIntercept) {
</span></span><span style=display:flex><span>     <span style=color:#75715e>// onInterceptTouchEvent æ–¹æ³•åœ¨è¿™</span>
</span></span><span style=display:flex><span>     intercepted <span style=color:#f92672>=</span> onInterceptTouchEvent(ev);
</span></span><span style=display:flex><span>     ev.<span style=color:#a6e22e>setAction</span>(action); <span style=color:#75715e>// restore action in case it was changed</span>
</span></span><span style=display:flex><span>   } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>     intercepted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// There are no touch targets and this action is not an initial down</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// so this view group continues to intercept touches.</span>
</span></span><span style=display:flex><span>    intercepted <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä¸ª actionMasked == MotionEvent.ACTION_DOWN ä¸ç”¨å¤šè¯´ï¼Œå¦‚æœäº‹ä»¶ç”± ViewGroup æ‹¦æˆªçš„è¯ï¼Œé‚£ä¹ˆåé¢çš„ mFirstTouchTarget != null ä¸­çš„ mFirstTouchTarget æ˜¯æŒ‡å‘å­å…ƒç´ çš„ï¼Œä¸€æ—¦äº‹ä»¶ç”± ViewGroup æ‹¦æˆªï¼Œé‚£ä¹ˆåé¢çš„ ACTION_MOVE, ACTION_UP ç»è¿‡è¿™é‡Œæ—¶ï¼Œ (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) ä¼šè¿”å› falseï¼Œæ‰€ä»¥ ViewGroup çš„ onInterceptTouchEvent ä¸ä¼šå†è¢«è°ƒç”¨ï¼Œä¸”åŒä¸€äº‹ä»¶åºåˆ—çš„å…¶ä»–äº‹ä»¶éƒ½äº¤ç”±å®ƒå¤„ç†ã€‚</p><p>å¦‚æœ ViewGroup ä¸æ‹¦æˆªï¼Œé‚£ä¹ˆ mFirstTouchTarget ä¼šæŒ‡å‘å­å…ƒç´ ï¼ŒmFirstTouchTarget != null ä¸º trueï¼Œåˆ™ä¼šè°ƒç”¨ onInterceptTouchEvent ï¼Œæ˜¾è€Œæ˜“è§ä¸æ˜¯å—ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ä»”ç»†æƒ³æƒ³ï¼Œç¬¬ä¸€ä¸ªä¼ é€’åˆ°è¿™é‡Œçš„äº‹ä»¶ç»å¸¸æ˜¯ ACTION_DOWNï¼Œå¦‚æœæ‹¦æˆªé‚£ä¹ˆåç»­çš„åŒä¸€äº‹ä»¶åºåˆ—ä¸­çš„å…¶ä»–äº‹ä»¶éƒ½ä¼šäº¤ç»™å®ƒå¤„ç†ï¼Œè¿™æ—¶å€™ onInterceptTouchEvent è¢«è°ƒç”¨ã€‚</p><p>å‡å¦‚åé¢åˆæ¥äº†ä¸ª ACTION_MOVEï¼Œè¿™æ—¶å€™å› ä¸º (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) ä¸º false ä¼šç›´æ¥æ‹¦æˆªï¼Œä½†ä¸ä¼šè°ƒç”¨ onInterceptTouchEvent äº†ã€‚</p><p>è¿™å°±è¯æ˜äº†ï¼šå¦‚æœä¸€ä¸ª View ä¸€æ—¦å†³å®šæ‹¦æˆªï¼Œé‚£ä¹ˆå°†ä¸å†è°ƒç”¨ onInterceptTouchEvent æ¥è¯¢é—®æ˜¯å¦æ‹¦æˆªã€‚</p><p>ä½ ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåä¸º FLAG_DISALLOW_INTERCEPT çš„æ ‡è®°ä½ï¼Œå¦‚æœå­ View è®¾ç½®äº†è¿™ä¸ªæ ‡è®°ä½ï¼Œé‚£ä¹ˆ</p><p>(!disallowIntercept) è¡¨è¾¾å¼åˆ™ä¸º falseï¼Œçˆ¶ View åˆ™ä¸ä¼šæ‹¦æˆªæ­¤äº‹ä»¶ï¼Œå½“ç„¶ ACTION_DOWN äº‹ä»¶é™¤å¤–ï¼Œå› ä¸º View åˆ¤æ–­å¦‚æœæ˜¯ ACTION_DOWN åˆ™ä¼šé‡ç½®è¿™ä¸ªæ ‡è®°ä½ã€‚</p><p>æ ‡è®°ä½é‡ç½®ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Handle an initial down.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (actionMasked <span style=color:#f92672>==</span> MotionEvent.<span style=color:#a6e22e>ACTION_DOWN</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Throw away all previous state when starting a new touch gesture.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The framework may have dropped the up or cancel event for the previous gesture</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// due to an app switch, ANR, or some other state change.</span>
</span></span><span style=display:flex><span>   cancelAndClearTouchTargets(ev);
</span></span><span style=display:flex><span>   resetTouchState();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å†çœ‹ ViewGroup ä¸æ‹¦æˆªçš„æ—¶å€™ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childrenCount <span style=color:#f92672>=</span> mChildrenCount;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (newTouchTarget <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> childrenCount <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> x <span style=color:#f92672>=</span> ev.<span style=color:#a6e22e>getX</span>(actionIndex);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> y <span style=color:#f92672>=</span> ev.<span style=color:#a6e22e>getY</span>(actionIndex);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ArrayList<span style=color:#f92672>&lt;</span>View<span style=color:#f92672>&gt;</span> preorderedList <span style=color:#f92672>=</span> buildTouchDispatchChildList();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> customOrder <span style=color:#f92672>=</span> preorderedList <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> isChildrenDrawingOrderEnabled();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> View<span style=color:#f92672>[]</span> children <span style=color:#f92672>=</span> mChildren;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> childrenCount <span style=color:#f92672>-</span> 1; i <span style=color:#f92672>&gt;=</span> 0; i<span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> childIndex <span style=color:#f92672>=</span> getAndVerifyPreorderedIndex(
</span></span><span style=display:flex><span>                childrenCount, i, customOrder);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// child </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> View child <span style=color:#f92672>=</span> getAndVerifyPreorderedView(
</span></span><span style=display:flex><span>                preorderedList, children, childIndex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (childWithAccessibilityFocus <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (childWithAccessibilityFocus <span style=color:#f92672>!=</span> child) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            childWithAccessibilityFocus <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            i <span style=color:#f92672>=</span> childrenCount <span style=color:#f92672>-</span> 1;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>canViewReceivePointerEvents(child)
</span></span><span style=display:flex><span>                <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>isTransformedTouchPointInView(x, y, child, <span style=color:#66d9ef>null</span>)) {
</span></span><span style=display:flex><span>            ev.<span style=color:#a6e22e>setTargetAccessibilityFocus</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        newTouchTarget <span style=color:#f92672>=</span> getTouchTarget(child);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (newTouchTarget <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            newTouchTarget.<span style=color:#a6e22e>pointerIdBits</span> <span style=color:#f92672>|=</span> idBitsToAssign;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        resetCancelNextUpFlag(child);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// dispatchTransformedTouchEvent åˆ™æ˜¯è°ƒç”¨å­å…ƒç´ çš„ dispatchTouchEvent</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (dispatchTransformedTouchEvent(ev, <span style=color:#66d9ef>false</span>, child, idBitsToAssign)) {
</span></span><span style=display:flex><span>            mLastTouchDownTime <span style=color:#f92672>=</span> ev.<span style=color:#a6e22e>getDownTime</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (preorderedList <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// childIndex points into presorted list, find original index</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0; j <span style=color:#f92672>&lt;</span> childrenCount; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (children<span style=color:#f92672>[</span>childIndex<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> mChildren<span style=color:#f92672>[</span>j<span style=color:#f92672>]</span>) {
</span></span><span style=display:flex><span>                        mLastTouchDownIndex <span style=color:#f92672>=</span> j;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                mLastTouchDownIndex <span style=color:#f92672>=</span> childIndex;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            mLastTouchDownX <span style=color:#f92672>=</span> ev.<span style=color:#a6e22e>getX</span>();
</span></span><span style=display:flex><span>            mLastTouchDownY <span style=color:#f92672>=</span> ev.<span style=color:#a6e22e>getY</span>();
</span></span><span style=display:flex><span>            newTouchTarget <span style=color:#f92672>=</span> addTouchTarget(child, idBitsToAssign);
</span></span><span style=display:flex><span>            alreadyDispatchedToNewTouchTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        ev.<span style=color:#a6e22e>setTargetAccessibilityFocus</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (preorderedList <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) preorderedList.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç®€å•è¯´ä¸€å§ï¼ŒdispatchTransformedTouchEvent åˆ™æ˜¯è°ƒç”¨å­å…ƒç´ çš„ dispatchTouchEventï¼ŒåŒæ¥å‘å­View åˆ†å‘äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹ dispatchTransformedTouchEvent æ–¹æ³•å†…å®¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> oldAction <span style=color:#f92672>=</span> event.<span style=color:#a6e22e>getAction</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (cancel <span style=color:#f92672>||</span> oldAction <span style=color:#f92672>==</span> MotionEvent.<span style=color:#a6e22e>ACTION_CANCEL</span>) {
</span></span><span style=display:flex><span>    event.<span style=color:#a6e22e>setAction</span>(MotionEvent.<span style=color:#a6e22e>ACTION_CANCEL</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (child <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å› ä¸º ViewGroup extends View ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ View çš„ dispatchTouchEvent æ–¹æ³•</span>
</span></span><span style=display:flex><span>        handled <span style=color:#f92672>=</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>dispatchTouchEvent</span>(event);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è°ƒç”¨å­ç±»çš„ dispatchTouchEvent</span>
</span></span><span style=display:flex><span>        handled <span style=color:#f92672>=</span> child.<span style=color:#a6e22e>dispatchTouchEvent</span>(event);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    event.<span style=color:#a6e22e>setAction</span>(oldAction);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿”å›å­ View æ˜¯å¦æ‹¦æˆª</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> handled;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¦‚æœ dispatchTransformedTouchEvent ä¸º trueï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ addTouchTarget æ–¹æ³•ä¸º mFirstTouchTarget èµ‹å€¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>newTouchTarget <span style=color:#f92672>=</span> addTouchTarget(child, idBitsToAssign);
</span></span><span style=display:flex><span><span style=color:#75715e>// å…·ä½“ addTouchTarget é‡Œçš„ä»£ç å°±ä¸çœ‹äº†</span>
</span></span><span style=display:flex><span>alreadyDispatchedToNewTouchTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span></code></pre></div><p>å¦‚æœæœ€åéå†æ‰€æœ‰å­å…ƒç´ äº‹ä»¶å´æ²¡æœ‰è¢«åˆé€‚çš„å¤„ç†ï¼Œè¦ä¹ˆæ˜¯ ViewGroup å†…æ²¡æœ‰åˆé€‚çš„å¯ä¼ é€’ Viewï¼Œè¦ä¹ˆæ˜¯å­ View æ‹¦æˆªå¹¶å¤„ç†äº†äº‹ä»¶ï¼Œä½† onTouchEvent è¿”å›äº† falseï¼Œæ‰€ä»¥ dispatchTouchEvent ä¹Ÿè¿”å›äº† falseã€‚</p><p>è¿™æ—¶ ViewGroup å°±è¦è‡ªå·±å¤„ç†äº‹ä»¶äº†ï¼ˆéœ‡æƒŠï¼å­¤å¯¡è€äººç«Ÿæ— å­å¯ç”¨ï¼è¿™ç©¶ç«Ÿæ˜¯&mldr;ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Dispatch to touch targets.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (mFirstTouchTarget <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// No touch targets so treat this as an ordinary view.</span>
</span></span><span style=display:flex><span>    handled <span style=color:#f92672>=</span> dispatchTransformedTouchEvent(ev, canceled, <span style=color:#66d9ef>null</span>, TouchTarget.<span style=color:#a6e22e>ALL_POINTER_IDS</span>)   
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è°ƒç”¨äº† dispatchTransformedTouchEven å¹¶åœ¨å‚æ•° child ä¼ å…¥äº† nullï¼Œå›é¡¾æˆ‘ä»¬ä¸Šé¢è´´å‡ºæ¥çš„ dispatchTransformedTouchEven æ–¹æ³•çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœä¸º child == nullåˆ™ä¼šè°ƒç”¨ ViewGroup è‡ªå·±çš„ dispatchTouchEventã€‚</p><p>ViewGroup çš„æºç è§£æåˆ°æ­¤ä¹Ÿå·®ä¸å¤šäº†ã€‚</p><h2 id=view-æºç è§£æ>View æºç è§£æ<a hidden class=anchor aria-hidden=true href=#view-æºç è§£æ>#</a></h2><p>æ¥ç€çœ‹å®ƒçš„ä¸€æ®µ dispatchTouchEvent ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>dispatchTouchEvent</span>(MotionEvent event) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (onFilterTouchEventForSecurity(event)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ((mViewFlags <span style=color:#f92672>&amp;</span> ENABLED_MASK) <span style=color:#f92672>==</span> ENABLED <span style=color:#f92672>&amp;&amp;</span> handleScrollBarDragging(event)) {
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        ListenerInfo li <span style=color:#f92672>=</span> mListenerInfo;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (li <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> li.<span style=color:#a6e22e>mOnTouchListener</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&amp;&amp;</span> (mViewFlags <span style=color:#f92672>&amp;</span> ENABLED_MASK) <span style=color:#f92672>==</span> ENABLED
</span></span><span style=display:flex><span>                <span style=color:#f92672>&amp;&amp;</span> li.<span style=color:#a6e22e>mOnTouchListener</span>.<span style=color:#a6e22e>onTouch</span>(<span style=color:#66d9ef>this</span>, event)) {
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>result <span style=color:#f92672>&amp;&amp;</span> onTouchEvent(event)) {
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œçš„ View åªå¤„ç†è‡ªå·±çš„äº‹ä»¶ï¼Œä¸ä¼šå†å‘ä¸‹ä¼ é€’äº‹ä»¶äº†ã€‚</p><p>æˆ‘ä»¬çœ‹å‘ä¸­é—´ç¬¬äºŒä¸ª if ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœè®¾ç½®äº† OnTouchListenerï¼Œä¸” onTouch æ–¹æ³•è¿”å›äº† trueï¼Œé‚£ä¹ˆ onTouchEvent å°±ä¸ä¼šæ‰§è¡Œï¼Œè¯æ˜äº†å‰é¢æ‰€è¯´çš„ OnTouchListener ä¼˜å…ˆçº§é«˜äº OnClickListenerã€‚</p><p>æˆ‘ä»¬å†çœ‹ onTouchEvent çš„ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> ((viewFlags <span style=color:#f92672>&amp;</span> ENABLED_MASK) <span style=color:#f92672>==</span> DISABLED) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (action <span style=color:#f92672>==</span> MotionEvent.<span style=color:#a6e22e>ACTION_UP</span> <span style=color:#f92672>&amp;&amp;</span> (mPrivateFlags <span style=color:#f92672>&amp;</span> PFLAG_PRESSED) <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>        setPressed(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (((viewFlags <span style=color:#f92672>&amp;</span> CLICKABLE) <span style=color:#f92672>==</span> CLICKABLE
</span></span><span style=display:flex><span>            <span style=color:#f92672>||</span> (viewFlags <span style=color:#f92672>&amp;</span> LONG_CLICKABLE) <span style=color:#f92672>==</span> LONG_CLICKABLE)
</span></span><span style=display:flex><span>            <span style=color:#f92672>||</span> (viewFlags <span style=color:#f92672>&amp;</span> CONTEXT_CLICKABLE) <span style=color:#f92672>==</span> CONTEXT_CLICKABLE);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å³ä½¿ View ä¸º disabled çŠ¶æ€ä¹Ÿèƒ½æ¶ˆè€—äº‹ä»¶ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> (((viewFlags <span style=color:#f92672>&amp;</span> CLICKABLE) <span style=color:#f92672>==</span> CLICKABLE <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        (viewFlags <span style=color:#f92672>&amp;</span> LONG_CLICKABLE) <span style=color:#f92672>==</span> LONG_CLICKABLE) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        (viewFlags <span style=color:#f92672>&amp;</span> CONTEXT_CLICKABLE) <span style=color:#f92672>==</span> CONTEXT_CLICKABLE) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åªè¦ clickable | longClickable å…¶ä¸­ä¸€ä¸ªä¸º true å°±èƒ½æ‰§è¡Œè¿™é‡Œï¼ŒonTouchEvent å°±ä¼šè¿”å› true</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (action) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> MotionEvent.<span style=color:#a6e22e>ACTION_UP</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å½“æ‰‹æŒ‡æŠ¬èµ·æ—¶</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> prepressed <span style=color:#f92672>=</span> (mPrivateFlags <span style=color:#f92672>&amp;</span> PFLAG_PREPRESSED) <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((mPrivateFlags <span style=color:#f92672>&amp;</span> PFLAG_PRESSED) <span style=color:#f92672>!=</span> 0 <span style=color:#f92672>||</span> prepressed) {
</span></span><span style=display:flex><span>                ...
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>mHasPerformedLongPress <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>mIgnoreNextUpEvent) {
</span></span><span style=display:flex><span>                    removeLongPressCallback();
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>focusTaken) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (mPerformClick <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                            mPerformClick <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PerformClick();
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>post(mPerformClick)) {
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// performClick å°†ä¼šè°ƒç”¨ onClick</span>
</span></span><span style=display:flex><span>                            performClick();
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                ...
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥ç€çœ‹ performClick æ–¹æ³•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>performClick</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> result;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ListenerInfo li <span style=color:#f92672>=</span> mListenerInfo;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (li <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> li.<span style=color:#a6e22e>mOnClickListener</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç‚¹å‡»éŸ³</span>
</span></span><span style=display:flex><span>        playSoundEffect(SoundEffectConstants.<span style=color:#a6e22e>CLICK</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// onClick åœ¨è¿™</span>
</span></span><span style=display:flex><span>        li.<span style=color:#a6e22e>mOnClickListener</span>.<span style=color:#a6e22e>onClick</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sendAccessibilityEvent(AccessibilityEvent.<span style=color:#a6e22e>TYPE_VIEW_CLICKED</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿˜æ²¡ç»“æŸï¼Œæˆ‘ä»¬å†çœ‹ä¸€çœ‹ setOnClickListener æ–¹æ³•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setOnClickListener</span>(OnClickListener l) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isClickable) {
</span></span><span style=display:flex><span>        setClickable(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    getListenerInfo.<span style=color:#a6e22e>mOnClickListener</span> <span style=color:#f92672>=</span> l;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°åœ¨è®¾ç½® View çš„ OnClickListenerä¼šè‡ªåŠ¨æ”¹å˜ View çš„ clickable å±æ€§ï¼Œè€Œ setOnLongClickListener ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><h1 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h1><ol><li>äº‹ä»¶åˆ†å‘æœºåˆ¶å°±æ˜¯ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘ï¼Œåœ¨æ‰‹æŒ‡æ¥è§¦å±å¹•åäº§ç”Ÿçš„åŒä¸€ä¸ªäº‹ä»¶åºåˆ—éƒ½æ˜¯ç‚¹å‡»äº‹ä»¶ã€‚</li><li>ç‚¹å‡»äº‹ä»¶çš„ä¼ é€’é¡ºåºæ˜¯ç”±å¤–å‘å†…ã€‚</li><li>æ­£å¸¸æƒ…å†µä¸‹ä¸€ä¸ªäº‹ä»¶åºåˆ—åªèƒ½è¢«ä¸€ä¸ª View æ‹¦æˆªä¸”æ¶ˆè€—ã€‚</li><li>å¦‚æœ View å†³å®šæ‹¦æˆªäº‹ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ªäº‹ä»¶åºåˆ—éƒ½ä¼šç”±è¿™ä¸ªViewæ¥å¤„ç†ã€‚</li><li>å½“å­ View æ‹¦æˆªå´ä¸ä¸æ¶ˆè€—ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ç‚¹å‡»äº‹ä»¶å°†äº¤ç”±ç»™ä»–çš„çˆ¶Viewå»å¤„ç†ï¼Œå¦‚æœæ‰€æœ‰çš„ View éƒ½æ²¡æœ‰æ¶ˆè€—æ‰ç‚¹å‡»äº‹ä»¶ï¼ˆonTouchEvent è¿”å› falseï¼‰ï¼Œæœ€ç»ˆ Activity ä¼šè°ƒç”¨è‡ªå·±çš„ onTouchEventã€‚</li><li>onInterceptTouchEvent æ–¹æ³•ä¸ä¸€å®šä¼šæ¯æ¬¡éƒ½æ‰§è¡Œï¼Œä¸€ä¸ª View ä¸€æ—¦å†³å®šæ‹¦æˆªå°†ä¸ä¼šè°ƒç”¨ onInterceptTouchEvent</li><li>OnTouchListenerçš„ä¼˜å…ˆçº§é«˜äºonTouchEvent()ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯æ–¹ä¾¿åœ¨å¤–éƒ¨å¤„ç†äº‹ä»¶ã€‚</li><li>å½“æˆ‘ä»¬æŠŠ View è®¾ç½®ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼ŒView ä¾ç„¶ä¼šæ¶ˆè€—äº‹ä»¶ã€‚</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://moonlab.top/en/tags/android/>Android</a></li></ul></footer><script src=https://comment.moonlab.top/moontalk.js></script><div id=container></div><script>(new MoonTalk).init({page_key:window.location.href,server:"https:///comment.moonlab.top",element:"#container"})</script></article></main><aside class=rightbar><div class=rightbar-categories><h3>Categories</h3><ul class=rightbar-categories-first-list><li><a href=https://moonlab.top/en/categories/programming/>Programming</a> (4)<ul class=rightbar-categories-sec-list><li><a href=/tags/linux>Linux</a></li><li><a href=/tags/android>Android</a></li></ul></li><li><a href=https://moonlab.top/en/categories/%E5%85%B6%E4%BB%96/>å…¶ä»–</a> (1)<ul class=rightbar-categories-sec-list><li><a href=/tags/linux>Linux</a></li></ul></li></ul></div></aside></div><footer class=footer><img id=mooncounter-img style="margin:0 auto;margin-bottom:6px"></img>
<script src="//counter.moonlab.top/img?name=https://moonlab.top/"></script><span>&copy; 2025 <a href=https://moonlab.top/en/>MoonLab</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><a href=https://www.travellings.cn/go.html rel=noopener target=_blank><img style=height:27px alt=travelling src=https://www.travellings.cn/assets/logo.svg></a></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>