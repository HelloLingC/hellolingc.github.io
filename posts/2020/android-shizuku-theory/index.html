<!doctype html><html lang=cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android Shizukuæºç åˆ†æ | MoonLab</title>
<meta name=keywords content="Android"><meta name=description content="æœ¬æ–‡åˆ†æäº† Shizuku çš„æºç ï¼Œä»‹ç»äº†å…¶å¦‚ä½•é€šè¿‡ Binder å®ç°ä¸ Android ç³»ç»ŸæœåŠ¡çš„äº¤äº’ã€‚Shizuku åº”ç”¨å¼•å¯¼ç”¨æˆ·ä»¥ root æˆ– adb æ–¹å¼è¿è¡ŒæœåŠ¡è¿›ç¨‹ï¼Œåˆ©ç”¨ ShizukuBinderWrapper è¿›è¡Œç³»ç»Ÿéšè— API çš„è°ƒç”¨ã€‚æ–‡ç« è¯¦ç»†æ¢è®¨äº† ShizukuBinderWrapper çš„æ„é€ ã€transact æ–¹æ³•åŠå…¶ä¸ IShizukuService çš„é€šä¿¡è¿‡ç¨‹ï¼Œæœ€åç®€è¦æåŠ ShizukuService çš„å¯åŠ¨æµç¨‹ã€‚ä½œè€…è®¡åˆ’è¿›ä¸€æ­¥æ·±å…¥åˆ†æ Shizuku çš„å¯åŠ¨æœºåˆ¶ã€‚"><meta name=author content="LingC"><link rel=canonical href=https://moonlab.top/posts/2020/android-shizuku-theory/><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]},loader:{load:["ui/safe"]}}</script><link crossorigin=anonymous href=/assets/css/stylesheet.1ff5a7b3bb4a96bf1747dfa25e8031167d4537d7ae4b78fac2b752886047a06e.css rel="preload stylesheet" as=style><link rel=icon href=/moon.svg type=image/svg+xml><link rel=icon type=image/png sizes=16x16 href=https://moonlab.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://moonlab.top/favicon-32x32.png><link rel=apple-touch-icon href=https://moonlab.top/apple-touch-icon.png><link rel=mask-icon href=https://moonlab.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=cn href=https://moonlab.top/posts/2020/android-shizuku-theory/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Android Shizukuæºç åˆ†æ"><meta property="og:description" content="æœ¬æ–‡åˆ†æäº† Shizuku çš„æºç ï¼Œä»‹ç»äº†å…¶å¦‚ä½•é€šè¿‡ Binder å®ç°ä¸ Android ç³»ç»ŸæœåŠ¡çš„äº¤äº’ã€‚Shizuku åº”ç”¨å¼•å¯¼ç”¨æˆ·ä»¥ root æˆ– adb æ–¹å¼è¿è¡ŒæœåŠ¡è¿›ç¨‹ï¼Œåˆ©ç”¨ ShizukuBinderWrapper è¿›è¡Œç³»ç»Ÿéšè— API çš„è°ƒç”¨ã€‚æ–‡ç« è¯¦ç»†æ¢è®¨äº† ShizukuBinderWrapper çš„æ„é€ ã€transact æ–¹æ³•åŠå…¶ä¸ IShizukuService çš„é€šä¿¡è¿‡ç¨‹ï¼Œæœ€åç®€è¦æåŠ ShizukuService çš„å¯åŠ¨æµç¨‹ã€‚ä½œè€…è®¡åˆ’è¿›ä¸€æ­¥æ·±å…¥åˆ†æ Shizuku çš„å¯åŠ¨æœºåˆ¶ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://moonlab.top/posts/2020/android-shizuku-theory/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-02T19:24:10+00:00"><meta property="article:modified_time" content="2020-02-02T19:24:10+00:00"><meta property="og:site_name" content="MoonLab"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android Shizukuæºç åˆ†æ"><meta name=twitter:description content="æœ¬æ–‡åˆ†æäº† Shizuku çš„æºç ï¼Œä»‹ç»äº†å…¶å¦‚ä½•é€šè¿‡ Binder å®ç°ä¸ Android ç³»ç»ŸæœåŠ¡çš„äº¤äº’ã€‚Shizuku åº”ç”¨å¼•å¯¼ç”¨æˆ·ä»¥ root æˆ– adb æ–¹å¼è¿è¡ŒæœåŠ¡è¿›ç¨‹ï¼Œåˆ©ç”¨ ShizukuBinderWrapper è¿›è¡Œç³»ç»Ÿéšè— API çš„è°ƒç”¨ã€‚æ–‡ç« è¯¦ç»†æ¢è®¨äº† ShizukuBinderWrapper çš„æ„é€ ã€transact æ–¹æ³•åŠå…¶ä¸ IShizukuService çš„é€šä¿¡è¿‡ç¨‹ï¼Œæœ€åç®€è¦æåŠ ShizukuService çš„å¯åŠ¨æµç¨‹ã€‚ä½œè€…è®¡åˆ’è¿›ä¸€æ­¥æ·±å…¥åˆ†æ Shizuku çš„å¯åŠ¨æœºåˆ¶ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://moonlab.top/posts/"},{"@type":"ListItem","position":2,"name":"Android Shizukuæºç åˆ†æ","item":"https://moonlab.top/posts/2020/android-shizuku-theory/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android Shizukuæºç åˆ†æ","name":"Android Shizukuæºç åˆ†æ","description":"æœ¬æ–‡åˆ†æäº† Shizuku çš„æºç ï¼Œä»‹ç»äº†å…¶å¦‚ä½•é€šè¿‡ Binder å®ç°ä¸ Android ç³»ç»ŸæœåŠ¡çš„äº¤äº’ã€‚Shizuku åº”ç”¨å¼•å¯¼ç”¨æˆ·ä»¥ root æˆ– adb æ–¹å¼è¿è¡ŒæœåŠ¡è¿›ç¨‹ï¼Œåˆ©ç”¨ ShizukuBinderWrapper è¿›è¡Œç³»ç»Ÿéšè— API çš„è°ƒç”¨ã€‚æ–‡ç« è¯¦ç»†æ¢è®¨äº† ShizukuBinderWrapper çš„æ„é€ ã€transact æ–¹æ³•åŠå…¶ä¸ IShizukuService çš„é€šä¿¡è¿‡ç¨‹ï¼Œæœ€åç®€è¦æåŠ ShizukuService çš„å¯åŠ¨æµç¨‹ã€‚ä½œè€…è®¡åˆ’è¿›ä¸€æ­¥æ·±å…¥åˆ†æ Shizuku çš„å¯åŠ¨æœºåˆ¶ã€‚","keywords":["Android"],"articleBody":"å‰è¨€ ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä½¿ç”¨äº† Shizuku å»è°ƒç”¨ç³»ç»ŸAPIï¼šæ–‡ç« é“¾æ¥\nè¿™æ¬¡å°±æ¥çœ‹çœ‹ Shizuku çš„æºç æ˜¯æ€ä¹ˆå†™çš„ã€‚\næœ€å¼€å§‹æˆ‘ç”¨ Notepad++ çœ‹ï¼Œæœ€åè¿˜æ˜¯ç”¨ as çœ‹æºç å¥½ç‚¹å§ã€‚\nå®˜æ–¹æ–‡æ¡£\né…·å®‰ä¸‹è½½ ShizukuManager\nWatch it on GitHub\nShizuku æ˜¯ä»€ä¹ˆï¼Ÿ Shizuku app ä¼šå¼•å¯¼ç”¨æˆ·ä½¿ç”¨ root æˆ–æ˜¯ adb æ–¹å¼è¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼ˆShizuku æœåŠ¡è¿›ç¨‹ï¼‰ã€‚\nåº”ç”¨è¿›ç¨‹å¯åŠ¨æ—¶ Shizuku æœåŠ¡è¿›ç¨‹å‘é€ binder è‡³åº”ç”¨è¿›ç¨‹ åº”ç”¨é€šè¿‡è¯¥ binder ä¸ Shizuku æœåŠ¡è¿›ç¨‹äº¤äº’ï¼ŒShizuku æœåŠ¡è¿›ç¨‹é€šè¿‡ binder ä¸ system server äº¤äº’ æ­£æ–‡ ShizukuBinderWrapper é¦–å…ˆæˆ‘ä»¬çœ‹ï¼Œåœ¨å¼€å‘æ—¶è°ƒç”¨ Shizuku çš„ä»£ç ï¼š\nprivate static final IPackageManager PACKAGE_MANAGER = IPackageManager.Stub.asInterface(new ShizukuBinderWrapper(SystemServiceHelper.getSystemService(\"package\"))); å®ƒä½¿æˆ‘ä»¬èƒ½éšæ„è°ƒç”¨ Android ç³»ç»Ÿä¸­ IPackageManager å†…çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿéšè—çš„APIï¼ˆæœ‰ @hide æ ‡ç­¾çš„æ–¹æ³•ï¼‰\næˆ‘ä»¬å¯ä»¥çœ‹åˆ° ShizukuBinderWrapper çš„æ„é€ æ–¹æ³•å†…ä¼ å…¥äº†ä¸€ä¸ª SystemServiceHelper#getSystemService æ–¹æ³•çš„è¿”å›å€¼ã€‚\nprivate static Map\u003cString, IBinder\u003e systemServiceCache = new HashMap\u003c\u003e(); public static IBinder getSystemService(@NonNull String name) { IBinder binder = systemServiceCache.get(name); if (binder == null) { binder = ServiceManager.getService(name); systemServiceCache.put(name, binder); } return binder; } getSystemService æ–¹æ³•å…ˆæŸ¥è¯¢äº†ä¸€ä¸‹ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜å°±è°ƒç”¨ ServiceManager çš„ getService æ–¹æ³•ã€‚è¿™ä¸ªæœ¬åœ°çš„ ServiceManager æ˜¯åœ¨ android.os åŒ…ä¸‹ï¼š\npackage android.os; public class ServiceManager { public static IBinder getService(String name) { throw new UnsupportedOperationException(); } } getService æ–¹æ³•ä¼šæ ¹æ® name å‚æ•°è¿”å›ä¸€ä¸ª IBinder æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥ä¸€ä¸‹ Android æºç ä¸­çš„ ServiceManager ç±»ï¼š\npublic final class ServiceManager { /** * Returns a reference to a service with the given name. * * @param name the name of the service to get * @return a reference to the service, or null if the service doesn't exist */ public static IBinder getService(String name) { try { IBinder service = sCache.get(name); if (service != null) { return service; } else { return Binder.allowBlocking(rawGetService(name)); } } catch (RemoteException e) { Log.e(TAG, \"error in getService\", e); } return null; } } å…¶ä¸­ getService ä¸æ˜¯ hide æ–¹æ³•å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚\næˆ‘ä»¬çœ‹çœ‹ ShizukuBinderWrapper çš„æ„é€ å‚æ•°ï¼š\nprivate IBinder original; // original æ˜¯ ServiceManager.getService è¿”å›çš„ IBinder public ShizukuBinderWrapper(@NonNull IBinder original) { // ä½¿ç”¨ requireNonNull æ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸º nullï¼Œå¦‚æœä¸º null æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ this.original = Objects.requireNonNull(original); } è¿™ä¸ªæ„é€ å‚æ•°å¯¹ original è¿›è¡Œäº†èµ‹å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ª IBinderã€‚\næˆ‘ä»¬å°†è¿™ä¸ª ShizukuBinderWrapper ä¼ å…¥Binder çš„ asInterface å°±èƒ½è·å¾—é€‚ç”¨äºå®¢æˆ·ç«¯çš„ Binder éšæ„è°ƒç”¨ IPackageiManager å†…çš„æ–¹æ³•ï¼Œå…¶ä¸­æˆ‘åœ¨æœ¬åœ°å†™çš„ IPackageManager åªæ˜¯ä¸ªç©ºå£³æ¥å£ï¼Œåªç»§æ‰¿äº† IInterface å£°æ˜äº†éœ€è¦çš„æ–¹æ³•ï¼š\npackage android.content.pm; // ä¸ Android ç³»ç»Ÿå†…çš„ IPackageManager åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ import android.os.Binder; import android.os.IBinder; import android.os.IInterface; import android.os.RemoteException; public interface IPackageManager extends IInterface { // æˆ‘åªéœ€è¦è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥åªå£°æ˜è¿™ä¸ªæ–¹æ³•æ¥è°ƒç”¨ ParceledListSlice\u003cPackageInfo\u003e getInstalledPackages(int flags, int userId) throws RemoteException; abstract class Stub extends Binder implements IPackageManager { public static IPackageManager asInterface(IBinder obj) { throw new UnsupportedOperationException(); } } } æˆ‘ä»¬æŸ¥çœ‹ ShizukuBinderWrapper çš„æºç ï¼Œ ShizukuBinderWrapper æœ¬èº«å°±å®ç°äº† IBinder æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½œä¸ºä¸Šè¿° asInterface æ–¹æ³•çš„å‚æ•°ã€‚\nè¿™æ˜¯ ShizukuBinderWrapper ä¸­çš„ transact æ–¹æ³•çš„é‡å†™ï¼š\n/* ShizukuBinderWrapper#transact */ @Override public boolean transact(int code, @NonNull Parcel data, @Nullable Parcel reply, int flags) throws RemoteException { Parcel newData = Parcel.obtain(); try { // ä½¿ç”¨ writeInterfaceToken å†™å…¥ ShizukuApiConstants.BINDER_DESCRIPTORï¼Œç”¨äºåé¢æœåŠ¡ç«¯çš„åˆ¤æ–­ newData.writeInterfaceToken(ShizukuApiConstants.BINDER_DESCRIPTOR); // å†™å…¥äº† original è¿™ä¸ª Binder newData.writeStrongBinder(original); newData.writeInt(code); newData.appendFrom(data, 0, data.dataSize()); ShizukuService.transactRemote(newData, reply, flags); } finally { newData.recycle(); } return true; } æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ aidl ä¸­æˆ‘ä»¬è°ƒç”¨ Binder çš„æ–¹æ³•æ—¶å®é™…ä¸Šéƒ½è°ƒç”¨äº†è¿™ä¸ª transact æ–¹æ³•ã€‚\nä¾‹å¦‚ï¼š\nprivate static final IPackageManager PACKAGE_MANAGER = IPackageManager.Stub.asInterface(new ShizukuBinderWrapper(SystemServiceHelper.getSystemService(\"package\"))); ParceledListSlice\u003cPackageInfo\u003e listSlice = PACKAGE_MANAGER.getInstalledPackages(flags, userId); è¿™é‡Œæˆ‘è°ƒç”¨ getInstalledPackages æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å†…éƒ¨å®é™…ä¸Šå°±è°ƒç”¨äº†ä¸Šé¢ ShizukuBinderWrapper è¿™ä¸ª Binder çš„ transact æ–¹æ³•ã€‚åœ¨è°ƒç”¨ getInstalledPackages è¿™ä¸ªç³»ç»Ÿæ–¹æ³•æ—¶ï¼Œå®ƒå†…éƒ¨å°±æŠŠæˆ‘ä»¬è°ƒç”¨ç³»ç»Ÿæ–¹æ³•æ‰€ä¼ å…¥çš„å‚æ•°å†™å…¥äº† data ä¸­å†ä¼ å…¥è¿™ä¸ª ShizukuBinderWrapper çš„ transact æ–¹æ³•ã€‚\nShizukuBinderWrapper çš„ transact æ–¹æ³•åˆæŠŠ data å’Œ reply ä¼ å…¥äº† ShizukuService çš„ transactRemote ä¸‹ï¼Œè¿™ä¸ª ShizukuService æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»é‡Œé¢æœ‰ä¸€äº›é™æ€å˜é‡å’Œæ–¹æ³•ã€‚\npackage moe.shizuku.api; /* ShizukuService#transactRemote */ public static void transactRemote(@NonNull Parcel data, @Nullable Parcel reply, int flags) throws RemoteException { // è°ƒç”¨ ShizukuService çš„ requireService æ–¹æ³• requireService().asBinder().transact(ShizukuApiConstants.BINDER_TRANSACTION_transact, data, reply, flags); } æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•ç”±è°ƒç”¨äº† requireService æ–¹æ³•å–å¾—äº† Binder å†è°ƒç”¨ Binder çš„ transact æ–¹æ³•ä¸æœåŠ¡ç«¯é€šä¿¡ ï¼Œå†çœ‹çœ‹ requireService æ–¹æ³•ï¼š\nprivate static IShizukuService requireService() { if (getService() == null) { throw new IllegalStateException(\"Binder haven't received, check Shizuku and your code.\"); } return getService(); } æ²¡ä»€ä¹ˆå¥½è§£é‡Šï¼Œç»§ç»­çœ‹ getService æ–¹æ³•ã€‚\n/* ShizukuService */ private static IShizukuService sService; public static void setBinder(IBinder binder) { sService = IShizukuService.Stub.asInterface(binder); } private static IShizukuService getService() { return sService; } è¿™ä¸ª getService é™æ€æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª IShizukuService ç±»å‹çš„ mServiceï¼Œè€Œè¿™ä¸ª mService æ˜¯ç”± setBinder è®¾ç½®çš„ï¼Œé‚£ä¹ˆæ˜¯è°è°ƒç”¨äº†è¿™ä¸ª ShizukuService.setBinder æ–¹æ³•æ¥è®¾ç½® mService ï¼Ÿæˆ‘ä»¬å…ˆä¸ç®¡å®ƒã€‚\nIShizukuService æˆ‘ä»¬å†æ³¨æ„ä¸€ä¸‹è¿™ä¸ª IShizukuServiceï¼š\n/* IShizukuService.aidl */ package moe.shizuku.server; import moe.shizuku.server.IRemoteProcess; interface IShizukuService { int getVersion() = 2; int getUid() = 3; int checkPermission(String permission) = 4; String getToken() = 5; boolean setPidToken(in String token) = 6; IRemoteProcess newProcess(in String[] cmd, in String[] env, in String dir) = 7; String getSELinuxContext() = 8; } è¿™ä¸ª AIDL çš„ä½œç”¨æ˜¯è®©æˆ‘ä»¬å¼€å‘çš„åº”ç”¨ä¸ Shhizuku çš„ç³»ç»Ÿè¿›ç¨‹è¿›è¡Œ Binder é€šä¿¡ã€‚\næˆ‘ä»¬ä¹‹å‰çš„ transactRemote æ–¹æ³•å·²ç»è°ƒç”¨äº†å®ƒçš„ Binder çš„ transact æ–¹æ³•å¼€å§‹è”ç³»æœåŠ¡ç«¯æŒ‚èµ·å®¢æˆ·ç«¯äº†ã€‚\næˆ‘ä»¬å†çœ‹ä¸ IShizukuService ç›¸å…³çš„ç±»ï¼š\npackage moe.shizuku.service public class ShizukuService extends IShizukuService.Stub { ... } å®ƒä¸åŒäºæˆ‘ä»¬åˆšæ‰çœ‹åˆ°çš„ moe.shizuku.api ä¸‹çš„ ShizukuService ï¼Œè¿™æ˜¯ moe.shizuku.service ä¸‹çš„ ShizukuServiceã€‚æ˜¯ä¸€ä¸ªçœŸçœŸæ­£æ­£çš„æœåŠ¡ç«¯ï¼Œå’Œ Android ç³»ç»Ÿä¸­çš„ç³»ç»ŸæœåŠ¡ï¼ˆä¾‹å¦‚AMS, PMSï¼‰ç±»ä¼¼æ²¡æœ‰ç›´æ¥ç»§æ‰¿ Service ç±»ï¼Œè€Œæ˜¯ç»§æ‰¿è‡ªä¸€ä¸ª Binderï¼ˆåé¢æˆ‘ä»¬å†è¯´ï¼‰ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹å®ƒé‡å†™çš„ onTransact æ–¹æ³•ï¼š\n@Override public boolean onTransact(int code, Parcel data, Parcel reply, int flags) throws RemoteException { if (code == ShizukuApiConstants.BINDER_TRANSACTION_transact) { data.enforceInterface(ShizukuApiConstants.BINDER_DESCRIPTOR); transactRemote(data, reply, flags); return true; } return super.onTransact(code, data, reply, flags); } å…ˆç”¨ enforceInterface æ–¹æ³•æ£€æŸ¥ä¸€ä¸‹ Interface æ˜¯å¦ä¸å®¢æˆ·ç«¯çš„ç›¸åŒï¼Œå†è°ƒç”¨äº† transactRemote æ–¹æ³•ï¼š\nprivate void transactRemote(Parcel data, Parcel reply, int flags) throws RemoteException { IBinder targetBinder = data.readStrongBinder(); int targetCode = data.readInt(); enforceCallingPermission(\"transactRemote\", true); targetBinder.getInterfaceDescriptor(), targetCode); Parcel newData = Parcel.obtain(); try { newData.appendFrom(data, data.dataPosition(), data.dataAvail()); } catch (Throwable tr) { LOGGER.w(tr, \"appendFrom\"); return; } try { long id = Binder.clearCallingIdentity(); // here targetBinder.transact(targetCode, newData, reply, flags); Binder.restoreCallingIdentity(id); } finally { newData.recycle(); } } æˆ‘ä»¬å¯ä»¥çœ‹åˆ° targetBinder å…¶å®å°±æ˜¯æˆ‘ä»¬ä¹‹å‰ç”¨ SystemServiceHelper çš„ getService æ–¹æ³•å¾—åˆ°çš„ Binderï¼Œåœ¨è°ƒç”¨å®ƒçš„ transact æ–¹æ³•ï¼Œå®ç° Shizuku æœåŠ¡ä¸ä½ æƒ³è¦é€šä¿¡çš„ç³»ç»ŸæœåŠ¡è¿›è¡Œ Binder é€šä¿¡ï¼Œæ¯•ç«Ÿ Shizuku æœåŠ¡å·²ç»é€šè¿‡ adb æˆ– root æˆä¸ºäº† dalaoã€‚\nShizukuService çš„å¯åŠ¨ ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†æˆ‘ä»¬ç”¨åˆ°äº† ShizukuService å»å®Œæˆåº”ç”¨ä¸ç³»ç»ŸæœåŠ¡çš„é€šä¿¡ï¼Œè€Œè¿™ä¸ªé™æ€å˜é‡ mService æ˜¯é€šè¿‡ ShizukuService#setBinder æ–¹æ³•è®¾ç½®çš„ï¼š\npackage moe.shizuku.api; public class ShizukuService { private static IShizukuService sService; public static void setBinder(IBinder binder) { sService = IShizukuService.Stub.asInterface(binder); } } é¦–å…ˆï¼ŒStarter ç±»ä¸­çš„ main æ–¹æ³•ä¼šå¯åŠ¨ ShizukuService æœåŠ¡ï¼š\npublic static void main(String[] args) throws IOException, RemoteException, InterruptedException { fixFilesOwner(); waitServiceManager(); waitSystemService(\"package\"); waitSystemService(\"activity\"); waitSystemService(Context.USER_SERVICE); waitSystemService(Context.APP_OPS_SERVICE); checkManagerApp(); if (Build.VERSION.SDK_INT \u003e= 28) { disableHiddenApiBlacklist(); } LOGGER.i(\"server v3\"); Looper.prepare(); // è¿™æ˜¯ moe.shizuku.service åŒ…ä¸‹çš„ç»§æ‰¿è‡ª Binder çš„ ShizukuService ShizukuService server = new ShizukuService(getToken(args)); server.sendBinderToManager(); server.sendBinderToClients(); Looper.loop(); LOGGER.i(\"server exit\"); System.exit(0); } å¯ä»¥çœ‹åˆ°è¿™é‡Œç›´æ¥ new äº†ä¸€ä¸ª ShizukuService å®ä¾‹ï¼Œè¿™å’Œä¸€äº›ç³»ç»ŸæœåŠ¡å¯åŠ¨æ–¹æ³•ç±»ä¼¼ã€‚\nå…¶ä¸­è°ƒç”¨äº† ShizukuService çš„ sendBinderToClients æ–¹æ³•ï¼Œè¿™ä¸­é—´æœ‰ä¸€å¤§å † dalao æ“ä½œï¼Œæˆ‘ä»¬ä¸ä½œè¯¦ç»†å…³æ³¨ï¼Œæ³¥èŒå¯è‡ªè¡Œé˜…è¯»æºç ã€‚\næœ€åä¼šè°ƒç”¨ ShuzikuService çš„ sendBinderToUserApp æ–¹æ³•ï¼Œç•¥è¿‡äº†ä¸€äº›å…¶ä»–çš„ä»£ç ï¼š\nstatic void sendBinderToUserApp(Binder binder, String packageName, int userId) { ... Bundle extra = new Bundle(); extra.putParcelable(ShizukuApiConstants.EXTRA_BINDER, new BinderContainer(binder)); Bundle reply = IContentProviderHelper.call(provider, null, name, \"sendBinder\", null, extra); ... } å°† ShizukuService è¿™ä¸ª Binder åŒ…è£…æˆä¸€ä¸ª BinderContainer ç±»ç„¶åæ”¾å…¥ Bundle é‡Œã€‚\nè¿™ä¸ª IContentProviderHelper çš„ call æ–¹æ³•ä¼šè·¨è¿›ç¨‹è°ƒç”¨ ShizukuBinderReceiveProvider è¿™ä¸ª ContentProvider çš„ call æ–¹æ³•ï¼š\n@Nullable @Override public final Bundle call(@NonNull String method, @Nullable String arg, @Nullable Bundle extras) { if (extras == null) return null; Bundle reply = new Bundle(); extras.setClassLoader(BinderContainer.class.getClassLoader()); switch (method) { case METHOD_SEND_BINDER: { if (ShizukuService.pingBinder()) { Log.i(\"ShizukuClient\", \"ShizukuBinderReceiveProvider started when already a binder alive\"); break; } BinderContainer container = extras.getParcelable(ShizukuApiConstants.EXTRA_BINDER); if (container != null \u0026\u0026 container.binder != null) { Log.i(\"ShizukuClient\", \"binder received\"); // è°ƒç”¨ ShizukuService çš„ setBinder é™æ€æ–¹æ³•å°†é™æ€å˜é‡ mService è®¾ç½®æˆä¹‹å‰åœ¨ app_process è¿›ç¨‹å¯åŠ¨çš„ ShizukuService çš„ Binder ShizukuService.setBinder(container.binder); //noinspection ConstantConditions Intent intent = new Intent(ShizukuMultiProcessHelper.ACTION_BINDER_RECEIVED) .putExtra(ShizukuApiConstants.EXTRA_BINDER, container) .setPackage(getContext().getPackageName()); getContext().sendBroadcast(intent); } ... break; } ... } return reply; } å…¶ä¸­è°ƒç”¨äº† ShizukuService çš„ setBinder æ–¹æ³•ï¼Œå°† IShuzukuService ä¼ è¿›å»äº†ã€‚\næœ«è¯­ å®é™…ä¸Šè¿™åªåˆ†æäº†ä¸€éƒ¨åˆ†ï¼Œå…³äº ShizukuService å…·ä½“çš„å¦‚ä½•å¯åŠ¨ï¼Œè¿™ä¸ª main æ–¹æ³•æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Œå’Œå…³äº start.sh çš„ä¸€äº›é—®é¢˜ï¼Œæˆ–è®¸æœ‰ç”Ÿä¹‹å¹´æˆ‘èƒ½æ°´å†™å‡ºç¬¬äºŒç¯‡æ–‡ç« â€¦\nShizuku å†…è¿˜æœ‰å¥½å¤š dalaoæ“ä½œï¼Œæˆ‘éƒ½æ²¡æœ‰å»çœ‹ï¼ŒåªæŠŠé‡è¦çš„ä¸€éƒ¨åˆ†å†™äº†ä¸‹æ¥ã€‚\næœç„¶åªæœ‰ dalaoæ‰èƒ½è¿™æ ·æ“ä½œï¼Œæˆ‘è¿˜æ˜¯ç»§ç»­èººç€å§ã€‚\nOrz\n2020-02-04ï¼š\næ—¶éš”ä¸¤å¤©ï¼Œæˆ‘åˆå†™å‡ºäº†ç¬¬äºŒç¯‡æ–‡ç« å•¦ï¼šhttps://lcblog.cn/post/android-shizuku-theory2\nå°è¯•å…·ä½“åˆ†æ Starter ç±»æ˜¯å¦‚ä½•å¯åŠ¨çš„ã€‚\n","wordCount":"1038","inLanguage":"cn","datePublished":"2020-02-02T19:24:10Z","dateModified":"2020-02-02T19:24:10Z","author":{"@type":"Person","name":"LingC"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moonlab.top/posts/2020/android-shizuku-theory/"},"publisher":{"@type":"Organization","name":"MoonLab","logo":{"@type":"ImageObject","url":"https://moonlab.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://moonlab.top/ accesskey=h title="MoonLab (Alt + H)"><img src=/moon.svg alt aria-label=logo height=20>MoonLab</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://moonlab.top/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://moonlab.top/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://moonlab.top/search/ title=æœç´¢><span>æœç´¢</span></a></li><li><a href=https://moonlab.top/about/ title=å…³äº><span>å…³äº</span></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=å¼€å¾€><span>å¼€å¾€</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><div class=body-layout><div class=leftbar></div><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Android Shizukuæºç åˆ†æ</h1><div class=post-meta><span title='2020-02-02 19:24:10 +0000 UTC'>February 2, 2020</span>&nbsp;Â·&nbsp;LingC</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=å‰è¨€>å‰è¨€</a><ul><li><a href=#shizuku-%e6%98%af%e4%bb%80%e4%b9%88 aria-label="Shizuku æ˜¯ä»€ä¹ˆï¼Ÿ">Shizuku æ˜¯ä»€ä¹ˆï¼Ÿ</a></li></ul></li><li><a href=#%e6%ad%a3%e6%96%87 aria-label=æ­£æ–‡>æ­£æ–‡</a><ul><li><a href=#shizukubinderwrapper aria-label=ShizukuBinderWrapper>ShizukuBinderWrapper</a></li><li><a href=#ishizukuservice aria-label=IShizukuService>IShizukuService</a></li><li><a href=#shizukuservice-%e7%9a%84%e5%90%af%e5%8a%a8 aria-label="ShizukuService çš„å¯åŠ¨">ShizukuService çš„å¯åŠ¨</a></li></ul></li><li><a href=#%e6%9c%ab%e8%af%ad aria-label=æœ«è¯­>æœ«è¯­</a></li></ul></div></details></div><div class=post-summary><span class=bold-text>ğŸ“¦ ç”±AIç”Ÿæˆçš„æ‘˜è¦</span><br><span class=post-summary-main>æœ¬æ–‡åˆ†æäº† Shizuku çš„æºç ï¼Œä»‹ç»äº†å…¶å¦‚ä½•é€šè¿‡ Binder å®ç°ä¸ Android ç³»ç»ŸæœåŠ¡çš„äº¤äº’ã€‚Shizuku åº”ç”¨å¼•å¯¼ç”¨æˆ·ä»¥ root æˆ– adb æ–¹å¼è¿è¡ŒæœåŠ¡è¿›ç¨‹ï¼Œåˆ©ç”¨ ShizukuBinderWrapper è¿›è¡Œç³»ç»Ÿéšè— API çš„è°ƒç”¨ã€‚æ–‡ç« è¯¦ç»†æ¢è®¨äº† ShizukuBinderWrapper çš„æ„é€ ã€transact æ–¹æ³•åŠå…¶ä¸ IShizukuService çš„é€šä¿¡è¿‡ç¨‹ï¼Œæœ€åç®€è¦æåŠ ShizukuService çš„å¯åŠ¨æµç¨‹ã€‚ä½œè€…è®¡åˆ’è¿›ä¸€æ­¥æ·±å…¥åˆ†æ Shizuku çš„å¯åŠ¨æœºåˆ¶ã€‚</span></div><div class=post-content><h1 id=å‰è¨€>å‰è¨€<a hidden class=anchor aria-hidden=true href=#å‰è¨€>#</a></h1><p>ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä½¿ç”¨äº† Shizuku å»è°ƒç”¨ç³»ç»ŸAPIï¼š<a href=https://lcblog.cn/post/android-activity-monitor>æ–‡ç« é“¾æ¥</a></p><p>è¿™æ¬¡å°±æ¥çœ‹çœ‹ Shizuku çš„æºç æ˜¯æ€ä¹ˆå†™çš„ã€‚</p><p>æœ€å¼€å§‹æˆ‘ç”¨ Notepad++ çœ‹ï¼Œæœ€åè¿˜æ˜¯ç”¨ as çœ‹æºç å¥½ç‚¹å§ã€‚</p><p><a href=https://shizuku.rikka.app/>å®˜æ–¹æ–‡æ¡£</a></p><p><a href=https://www.coolapk.com/apk/moe.shizuku.privileged.api>é…·å®‰ä¸‹è½½ ShizukuManager</a></p><p><a href=https://github.com/RikkaApps/Shizuku>Watch it on GitHub</a></p><h2 id=shizuku-æ˜¯ä»€ä¹ˆ>Shizuku æ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class=anchor aria-hidden=true href=#shizuku-æ˜¯ä»€ä¹ˆ>#</a></h2><blockquote><p>Shizuku app ä¼šå¼•å¯¼ç”¨æˆ·ä½¿ç”¨ root æˆ–æ˜¯ adb æ–¹å¼è¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼ˆShizuku æœåŠ¡è¿›ç¨‹ï¼‰ã€‚</p><ol><li>åº”ç”¨è¿›ç¨‹å¯åŠ¨æ—¶ Shizuku æœåŠ¡è¿›ç¨‹å‘é€ binder è‡³åº”ç”¨è¿›ç¨‹</li><li>åº”ç”¨é€šè¿‡è¯¥ binder ä¸ Shizuku æœåŠ¡è¿›ç¨‹äº¤äº’ï¼ŒShizuku æœåŠ¡è¿›ç¨‹é€šè¿‡ binder ä¸ system server äº¤äº’</li></ol></blockquote><h1 id=æ­£æ–‡>æ­£æ–‡<a hidden class=anchor aria-hidden=true href=#æ­£æ–‡>#</a></h1><h2 id=shizukubinderwrapper>ShizukuBinderWrapper<a hidden class=anchor aria-hidden=true href=#shizukubinderwrapper>#</a></h2><p>é¦–å…ˆæˆ‘ä»¬çœ‹ï¼Œåœ¨å¼€å‘æ—¶è°ƒç”¨ Shizuku çš„ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> IPackageManager PACKAGE_MANAGER <span style=color:#f92672>=</span> IPackageManager.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(<span style=color:#66d9ef>new</span> ShizukuBinderWrapper(SystemServiceHelper.<span style=color:#a6e22e>getSystemService</span>(<span style=color:#e6db74>&#34;package&#34;</span>)));
</span></span></code></pre></div><p>å®ƒä½¿æˆ‘ä»¬èƒ½éšæ„è°ƒç”¨ Android ç³»ç»Ÿä¸­ IPackageManager å†…çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿéšè—çš„APIï¼ˆæœ‰ @hide æ ‡ç­¾çš„æ–¹æ³•ï¼‰</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ShizukuBinderWrapper çš„æ„é€ æ–¹æ³•å†…ä¼ å…¥äº†ä¸€ä¸ª SystemServiceHelper#getSystemService æ–¹æ³•çš„è¿”å›å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String, IBinder<span style=color:#f92672>&gt;</span> systemServiceCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>(); 
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IBinder <span style=color:#a6e22e>getSystemService</span>(<span style=color:#a6e22e>@NonNull</span> String name) {
</span></span><span style=display:flex><span>        IBinder binder <span style=color:#f92672>=</span> systemServiceCache.<span style=color:#a6e22e>get</span>(name);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (binder <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            binder <span style=color:#f92672>=</span> ServiceManager.<span style=color:#a6e22e>getService</span>(name);
</span></span><span style=display:flex><span>            systemServiceCache.<span style=color:#a6e22e>put</span>(name, binder);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> binder;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>getSystemService æ–¹æ³•å…ˆæŸ¥è¯¢äº†ä¸€ä¸‹ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜å°±è°ƒç”¨ ServiceManager çš„ getService æ–¹æ³•ã€‚è¿™ä¸ªæœ¬åœ°çš„ ServiceManager æ˜¯åœ¨ android.os åŒ…ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> android.os;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceManager</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IBinder <span style=color:#a6e22e>getService</span>(String name) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> UnsupportedOperationException();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>getService æ–¹æ³•ä¼šæ ¹æ® name å‚æ•°è¿”å›ä¸€ä¸ª IBinder æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥ä¸€ä¸‹ Android æºç ä¸­çš„ ServiceManager ç±»ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceManager</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Returns a reference to a service with the given name.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param name the name of the service to get
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return a reference to the service, or &lt;code&gt;null&lt;/code&gt; if the service doesn&#39;t exist
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IBinder <span style=color:#a6e22e>getService</span>(String name) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            IBinder service <span style=color:#f92672>=</span> sCache.<span style=color:#a6e22e>get</span>(name);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (service <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> service;
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Binder.<span style=color:#a6e22e>allowBlocking</span>(rawGetService(name));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>            Log.<span style=color:#a6e22e>e</span>(TAG, <span style=color:#e6db74>&#34;error in getService&#34;</span>, e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä¸­ getService ä¸æ˜¯ hide æ–¹æ³•å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬çœ‹çœ‹ ShizukuBinderWrapper çš„æ„é€ å‚æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#66d9ef>private</span> IBinder original;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// original æ˜¯ ServiceManager.getService è¿”å›çš„ IBinder</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ShizukuBinderWrapper</span>(<span style=color:#a6e22e>@NonNull</span> IBinder original) {
</span></span><span style=display:flex><span>     <span style=color:#75715e>// ä½¿ç”¨ requireNonNull æ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸º nullï¼Œå¦‚æœä¸º null æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>original</span> <span style=color:#f92672>=</span> Objects.<span style=color:#a6e22e>requireNonNull</span>(original);
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>è¿™ä¸ªæ„é€ å‚æ•°å¯¹ original è¿›è¡Œäº†èµ‹å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ª IBinderã€‚</p><p>æˆ‘ä»¬å°†è¿™ä¸ª ShizukuBinderWrapper ä¼ å…¥Binder çš„ asInterface å°±èƒ½è·å¾—é€‚ç”¨äºå®¢æˆ·ç«¯çš„ Binder éšæ„è°ƒç”¨ IPackageiManager å†…çš„æ–¹æ³•ï¼Œå…¶ä¸­æˆ‘åœ¨æœ¬åœ°å†™çš„ IPackageManager åªæ˜¯ä¸ªç©ºå£³æ¥å£ï¼Œåªç»§æ‰¿äº† IInterface å£°æ˜äº†éœ€è¦çš„æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> android.content.pm;
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸ Android ç³»ç»Ÿå†…çš„ IPackageManager åœ¨åŒä¸€ä¸ªåŒ…ä¸‹</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.os.Binder;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.os.IBinder;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.os.IInterface;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.os.RemoteException;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IPackageManager</span> <span style=color:#66d9ef>extends</span> IInterface {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æˆ‘åªéœ€è¦è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥åªå£°æ˜è¿™ä¸ªæ–¹æ³•æ¥è°ƒç”¨</span>
</span></span><span style=display:flex><span>    ParceledListSlice<span style=color:#f92672>&lt;</span>PackageInfo<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getInstalledPackages</span>(<span style=color:#66d9ef>int</span> flags, <span style=color:#66d9ef>int</span> userId) <span style=color:#66d9ef>throws</span> RemoteException;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stub</span> <span style=color:#66d9ef>extends</span> Binder <span style=color:#66d9ef>implements</span> IPackageManager {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IPackageManager <span style=color:#a6e22e>asInterface</span>(IBinder obj) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> UnsupportedOperationException();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬æŸ¥çœ‹ ShizukuBinderWrapper çš„æºç ï¼Œ ShizukuBinderWrapper æœ¬èº«å°±å®ç°äº† IBinder æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½œä¸ºä¸Šè¿° asInterface æ–¹æ³•çš„å‚æ•°ã€‚</p><p>è¿™æ˜¯ ShizukuBinderWrapper ä¸­çš„ transact æ–¹æ³•çš„é‡å†™ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#75715e>/* ShizukuBinderWrapper#transact */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>transact</span>(<span style=color:#66d9ef>int</span> code, <span style=color:#a6e22e>@NonNull</span> Parcel data, <span style=color:#a6e22e>@Nullable</span> Parcel reply, <span style=color:#66d9ef>int</span> flags) <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span>        Parcel newData <span style=color:#f92672>=</span> Parcel.<span style=color:#a6e22e>obtain</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ä½¿ç”¨ writeInterfaceToken å†™å…¥ ShizukuApiConstants.BINDER_DESCRIPTORï¼Œç”¨äºåé¢æœåŠ¡ç«¯çš„åˆ¤æ–­</span>
</span></span><span style=display:flex><span>            newData.<span style=color:#a6e22e>writeInterfaceToken</span>(ShizukuApiConstants.<span style=color:#a6e22e>BINDER_DESCRIPTOR</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å†™å…¥äº† original è¿™ä¸ª Binder</span>
</span></span><span style=display:flex><span>            newData.<span style=color:#a6e22e>writeStrongBinder</span>(original);
</span></span><span style=display:flex><span>            newData.<span style=color:#a6e22e>writeInt</span>(code);
</span></span><span style=display:flex><span>            newData.<span style=color:#a6e22e>appendFrom</span>(data, 0, data.<span style=color:#a6e22e>dataSize</span>());
</span></span><span style=display:flex><span>            ShizukuService.<span style=color:#a6e22e>transactRemote</span>(newData, reply, flags);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            newData.<span style=color:#a6e22e>recycle</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ aidl ä¸­æˆ‘ä»¬è°ƒç”¨ Binder çš„æ–¹æ³•æ—¶å®é™…ä¸Šéƒ½è°ƒç”¨äº†è¿™ä¸ª transact æ–¹æ³•ã€‚</p><p>ä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> IPackageManager PACKAGE_MANAGER <span style=color:#f92672>=</span> IPackageManager.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(<span style=color:#66d9ef>new</span> ShizukuBinderWrapper(SystemServiceHelper.<span style=color:#a6e22e>getSystemService</span>(<span style=color:#e6db74>&#34;package&#34;</span>)));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ParceledListSlice<span style=color:#f92672>&lt;</span>PackageInfo<span style=color:#f92672>&gt;</span> listSlice <span style=color:#f92672>=</span> PACKAGE_MANAGER.<span style=color:#a6e22e>getInstalledPackages</span>(flags, userId);
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘è°ƒç”¨ getInstalledPackages æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å†…éƒ¨å®é™…ä¸Šå°±è°ƒç”¨äº†ä¸Šé¢ ShizukuBinderWrapper è¿™ä¸ª Binder çš„ transact æ–¹æ³•ã€‚åœ¨è°ƒç”¨ getInstalledPackages è¿™ä¸ªç³»ç»Ÿæ–¹æ³•æ—¶ï¼Œå®ƒå†…éƒ¨å°±æŠŠæˆ‘ä»¬è°ƒç”¨ç³»ç»Ÿæ–¹æ³•æ‰€ä¼ å…¥çš„å‚æ•°å†™å…¥äº† data ä¸­å†ä¼ å…¥è¿™ä¸ª ShizukuBinderWrapper çš„ transact æ–¹æ³•ã€‚</p><p>ShizukuBinderWrapper çš„ transact æ–¹æ³•åˆæŠŠ data å’Œ reply ä¼ å…¥äº† ShizukuService çš„ transactRemote ä¸‹ï¼Œè¿™ä¸ª ShizukuService æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»é‡Œé¢æœ‰ä¸€äº›é™æ€å˜é‡å’Œæ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> moe.shizuku.api;
</span></span><span style=display:flex><span><span style=color:#75715e>/* ShizukuService#transactRemote */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>transactRemote</span>(<span style=color:#a6e22e>@NonNull</span> Parcel data, <span style=color:#a6e22e>@Nullable</span> Parcel reply, <span style=color:#66d9ef>int</span> flags) <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span><span style=color:#75715e>// è°ƒç”¨ ShizukuService çš„ requireService æ–¹æ³•</span>
</span></span><span style=display:flex><span>requireService().<span style=color:#a6e22e>asBinder</span>().<span style=color:#a6e22e>transact</span>(ShizukuApiConstants.<span style=color:#a6e22e>BINDER_TRANSACTION_transact</span>, data, reply, flags);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•ç”±è°ƒç”¨äº† requireService æ–¹æ³•å–å¾—äº† Binder å†è°ƒç”¨ Binder çš„ transact æ–¹æ³•ä¸æœåŠ¡ç«¯é€šä¿¡ ï¼Œå†çœ‹çœ‹ requireService æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> IShizukuService <span style=color:#a6e22e>requireService</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (getService() <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;Binder haven&#39;t received, check Shizuku and your code.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getService();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>æ²¡ä»€ä¹ˆå¥½è§£é‡Šï¼Œç»§ç»­çœ‹ getService æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/* ShizukuService */</span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> IShizukuService sService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBinder</span>(IBinder binder) {
</span></span><span style=display:flex><span>        sService <span style=color:#f92672>=</span> IShizukuService.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(binder);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> IShizukuService <span style=color:#a6e22e>getService</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sService;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>è¿™ä¸ª getService é™æ€æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª IShizukuService ç±»å‹çš„ mServiceï¼Œè€Œè¿™ä¸ª mService æ˜¯ç”± setBinder è®¾ç½®çš„ï¼Œé‚£ä¹ˆæ˜¯è°è°ƒç”¨äº†è¿™ä¸ª ShizukuService.setBinder æ–¹æ³•æ¥è®¾ç½® mService ï¼Ÿæˆ‘ä»¬å…ˆä¸ç®¡å®ƒã€‚</p><h2 id=ishizukuservice>IShizukuService<a hidden class=anchor aria-hidden=true href=#ishizukuservice>#</a></h2><p>æˆ‘ä»¬å†æ³¨æ„ä¸€ä¸‹è¿™ä¸ª IShizukuServiceï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/* IShizukuService.aidl */</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> moe.shizuku.server;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> moe.shizuku.server.IRemoteProcess;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IShizukuService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getVersion</span>() <span style=color:#f92672>=</span> 2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getUid</span>() <span style=color:#f92672>=</span> 3;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>checkPermission</span>(String permission) <span style=color:#f92672>=</span> 4;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>getToken</span>() <span style=color:#f92672>=</span> 5;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>setPidToken</span>(in String token) <span style=color:#f92672>=</span> 6;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IRemoteProcess <span style=color:#a6e22e>newProcess</span>(in String<span style=color:#f92672>[]</span> cmd, in String<span style=color:#f92672>[]</span> env, in String dir) <span style=color:#f92672>=</span> 7;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>getSELinuxContext</span>() <span style=color:#f92672>=</span> 8;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä¸ª AIDL çš„ä½œç”¨æ˜¯è®©æˆ‘ä»¬å¼€å‘çš„åº”ç”¨ä¸ Shhizuku çš„ç³»ç»Ÿè¿›ç¨‹è¿›è¡Œ Binder é€šä¿¡ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰çš„ transactRemote æ–¹æ³•å·²ç»è°ƒç”¨äº†å®ƒçš„ Binder çš„ transact æ–¹æ³•å¼€å§‹è”ç³»æœåŠ¡ç«¯æŒ‚èµ·å®¢æˆ·ç«¯äº†ã€‚</p><p>æˆ‘ä»¬å†çœ‹ä¸ IShizukuService ç›¸å…³çš„ç±»ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> moe.shizuku.service
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShizukuService</span> <span style=color:#66d9ef>extends</span> IShizukuService.<span style=color:#a6e22e>Stub</span> {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å®ƒä¸åŒäºæˆ‘ä»¬åˆšæ‰çœ‹åˆ°çš„ moe.shizuku.api ä¸‹çš„ ShizukuService ï¼Œè¿™æ˜¯ moe.shizuku.service ä¸‹çš„ ShizukuServiceã€‚æ˜¯ä¸€ä¸ªçœŸçœŸæ­£æ­£çš„æœåŠ¡ç«¯ï¼Œå’Œ Android ç³»ç»Ÿä¸­çš„ç³»ç»ŸæœåŠ¡ï¼ˆä¾‹å¦‚AMS, PMSï¼‰ç±»ä¼¼æ²¡æœ‰ç›´æ¥ç»§æ‰¿ Service ç±»ï¼Œè€Œæ˜¯ç»§æ‰¿è‡ªä¸€ä¸ª Binderï¼ˆåé¢æˆ‘ä»¬å†è¯´ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹å®ƒé‡å†™çš„ onTransact æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onTransact</span>(<span style=color:#66d9ef>int</span> code, Parcel data, Parcel reply, <span style=color:#66d9ef>int</span> flags) <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (code <span style=color:#f92672>==</span> ShizukuApiConstants.<span style=color:#a6e22e>BINDER_TRANSACTION_transact</span>) {
</span></span><span style=display:flex><span>            data.<span style=color:#a6e22e>enforceInterface</span>(ShizukuApiConstants.<span style=color:#a6e22e>BINDER_DESCRIPTOR</span>);
</span></span><span style=display:flex><span>            transactRemote(data, reply, flags);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>onTransact</span>(code, data, reply, flags);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>å…ˆç”¨ enforceInterface æ–¹æ³•æ£€æŸ¥ä¸€ä¸‹ Interface æ˜¯å¦ä¸å®¢æˆ·ç«¯çš„ç›¸åŒï¼Œå†è°ƒç”¨äº† transactRemote æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>transactRemote</span>(Parcel data, Parcel reply, <span style=color:#66d9ef>int</span> flags) <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span>        IBinder targetBinder <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readStrongBinder</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> targetCode <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>        enforceCallingPermission(<span style=color:#e6db74>&#34;transactRemote&#34;</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        targetBinder.<span style=color:#a6e22e>getInterfaceDescriptor</span>(), targetCode);
</span></span><span style=display:flex><span>        Parcel newData <span style=color:#f92672>=</span> Parcel.<span style=color:#a6e22e>obtain</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            newData.<span style=color:#a6e22e>appendFrom</span>(data, data.<span style=color:#a6e22e>dataPosition</span>(), data.<span style=color:#a6e22e>dataAvail</span>());
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Throwable tr) {
</span></span><span style=display:flex><span>            LOGGER.<span style=color:#a6e22e>w</span>(tr, <span style=color:#e6db74>&#34;appendFrom&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>long</span> id <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>clearCallingIdentity</span>();
</span></span><span style=display:flex><span>            <span style=color:#75715e>// here</span>
</span></span><span style=display:flex><span>            targetBinder.<span style=color:#a6e22e>transact</span>(targetCode, newData, reply, flags);
</span></span><span style=display:flex><span>            Binder.<span style=color:#a6e22e>restoreCallingIdentity</span>(id);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            newData.<span style=color:#a6e22e>recycle</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° targetBinder å…¶å®å°±æ˜¯æˆ‘ä»¬ä¹‹å‰ç”¨ SystemServiceHelper çš„ getService æ–¹æ³•å¾—åˆ°çš„ Binderï¼Œåœ¨è°ƒç”¨å®ƒçš„ transact æ–¹æ³•ï¼Œå®ç° Shizuku æœåŠ¡ä¸ä½ æƒ³è¦é€šä¿¡çš„ç³»ç»ŸæœåŠ¡è¿›è¡Œ Binder é€šä¿¡ï¼Œæ¯•ç«Ÿ Shizuku æœåŠ¡å·²ç»é€šè¿‡ adb æˆ– root æˆä¸ºäº† dalaoã€‚</p><h2 id=shizukuservice-çš„å¯åŠ¨>ShizukuService çš„å¯åŠ¨<a hidden class=anchor aria-hidden=true href=#shizukuservice-çš„å¯åŠ¨>#</a></h2><p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†æˆ‘ä»¬ç”¨åˆ°äº† ShizukuService å»å®Œæˆåº”ç”¨ä¸ç³»ç»ŸæœåŠ¡çš„é€šä¿¡ï¼Œè€Œè¿™ä¸ªé™æ€å˜é‡ mService æ˜¯é€šè¿‡ ShizukuService#setBinder æ–¹æ³•è®¾ç½®çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> moe.shizuku.api;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShizukuService</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> IShizukuService sService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBinder</span>(IBinder binder) {
</span></span><span style=display:flex><span>        sService <span style=color:#f92672>=</span> IShizukuService.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(binder);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é¦–å…ˆï¼ŒStarter ç±»ä¸­çš„ main æ–¹æ³•ä¼šå¯åŠ¨ ShizukuService æœåŠ¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, RemoteException, InterruptedException {
</span></span><span style=display:flex><span>        fixFilesOwner();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        waitServiceManager();
</span></span><span style=display:flex><span>        waitSystemService(<span style=color:#e6db74>&#34;package&#34;</span>);
</span></span><span style=display:flex><span>        waitSystemService(<span style=color:#e6db74>&#34;activity&#34;</span>);
</span></span><span style=display:flex><span>        waitSystemService(Context.<span style=color:#a6e22e>USER_SERVICE</span>);
</span></span><span style=display:flex><span>        waitSystemService(Context.<span style=color:#a6e22e>APP_OPS_SERVICE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        checkManagerApp();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (Build.<span style=color:#a6e22e>VERSION</span>.<span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> 28) {
</span></span><span style=display:flex><span>            disableHiddenApiBlacklist();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>i</span>(<span style=color:#e6db74>&#34;server v3&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Looper.<span style=color:#a6e22e>prepare</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿™æ˜¯ moe.shizuku.service åŒ…ä¸‹çš„ç»§æ‰¿è‡ª Binder çš„ ShizukuService</span>
</span></span><span style=display:flex><span>        ShizukuService server <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ShizukuService(getToken(args));
</span></span><span style=display:flex><span>        server.<span style=color:#a6e22e>sendBinderToManager</span>();
</span></span><span style=display:flex><span>        server.<span style=color:#a6e22e>sendBinderToClients</span>();
</span></span><span style=display:flex><span>        Looper.<span style=color:#a6e22e>loop</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>i</span>(<span style=color:#e6db74>&#34;server exit&#34;</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>exit</span>(0);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç›´æ¥ new äº†ä¸€ä¸ª ShizukuService å®ä¾‹ï¼Œè¿™å’Œä¸€äº›ç³»ç»ŸæœåŠ¡å¯åŠ¨æ–¹æ³•ç±»ä¼¼ã€‚</p><p>å…¶ä¸­è°ƒç”¨äº† ShizukuService çš„ sendBinderToClients æ–¹æ³•ï¼Œè¿™ä¸­é—´æœ‰ä¸€å¤§å † dalao æ“ä½œï¼Œæˆ‘ä»¬ä¸ä½œè¯¦ç»†å…³æ³¨ï¼Œæ³¥èŒå¯è‡ªè¡Œé˜…è¯»æºç ã€‚</p><p>æœ€åä¼šè°ƒç”¨ ShuzikuService çš„ sendBinderToUserApp æ–¹æ³•ï¼Œç•¥è¿‡äº†ä¸€äº›å…¶ä»–çš„ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendBinderToUserApp</span>(Binder binder, String packageName, <span style=color:#66d9ef>int</span> userId) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>     Bundle extra <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Bundle();
</span></span><span style=display:flex><span>     extra.<span style=color:#a6e22e>putParcelable</span>(ShizukuApiConstants.<span style=color:#a6e22e>EXTRA_BINDER</span>, <span style=color:#66d9ef>new</span> BinderContainer(binder));
</span></span><span style=display:flex><span>     Bundle reply <span style=color:#f92672>=</span> IContentProviderHelper.<span style=color:#a6e22e>call</span>(provider, <span style=color:#66d9ef>null</span>, name, <span style=color:#e6db74>&#34;sendBinder&#34;</span>, <span style=color:#66d9ef>null</span>, extra);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å°† ShizukuService è¿™ä¸ª Binder åŒ…è£…æˆä¸€ä¸ª BinderContainer ç±»ç„¶åæ”¾å…¥ Bundle é‡Œã€‚</p><p>è¿™ä¸ª IContentProviderHelper çš„ call æ–¹æ³•ä¼šè·¨è¿›ç¨‹è°ƒç”¨ ShizukuBinderReceiveProvider è¿™ä¸ª ContentProvider çš„ call æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> Bundle <span style=color:#a6e22e>call</span>(<span style=color:#a6e22e>@NonNull</span> String method, <span style=color:#a6e22e>@Nullable</span> String arg, <span style=color:#a6e22e>@Nullable</span> Bundle extras) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (extras <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        Bundle reply <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Bundle();
</span></span><span style=display:flex><span>        extras.<span style=color:#a6e22e>setClassLoader</span>(BinderContainer.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getClassLoader</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (method) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_SEND_BINDER: {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (ShizukuService.<span style=color:#a6e22e>pingBinder</span>()) {
</span></span><span style=display:flex><span>                    Log.<span style=color:#a6e22e>i</span>(<span style=color:#e6db74>&#34;ShizukuClient&#34;</span>, <span style=color:#e6db74>&#34;ShizukuBinderReceiveProvider started when already a binder alive&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                BinderContainer container <span style=color:#f92672>=</span> extras.<span style=color:#a6e22e>getParcelable</span>(ShizukuApiConstants.<span style=color:#a6e22e>EXTRA_BINDER</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (container <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> container.<span style=color:#a6e22e>binder</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    Log.<span style=color:#a6e22e>i</span>(<span style=color:#e6db74>&#34;ShizukuClient&#34;</span>, <span style=color:#e6db74>&#34;binder received&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// è°ƒç”¨ ShizukuService çš„ setBinder é™æ€æ–¹æ³•å°†é™æ€å˜é‡ mService è®¾ç½®æˆä¹‹å‰åœ¨ app_process è¿›ç¨‹å¯åŠ¨çš„ ShizukuService çš„ Binder</span>
</span></span><span style=display:flex><span>                    ShizukuService.<span style=color:#a6e22e>setBinder</span>(container.<span style=color:#a6e22e>binder</span>);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//noinspection ConstantConditions</span>
</span></span><span style=display:flex><span>                    Intent intent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Intent(ShizukuMultiProcessHelper.<span style=color:#a6e22e>ACTION_BINDER_RECEIVED</span>)
</span></span><span style=display:flex><span>                            .<span style=color:#a6e22e>putExtra</span>(ShizukuApiConstants.<span style=color:#a6e22e>EXTRA_BINDER</span>, container)
</span></span><span style=display:flex><span>                            .<span style=color:#a6e22e>setPackage</span>(getContext().<span style=color:#a6e22e>getPackageName</span>());
</span></span><span style=display:flex><span>                    getContext().<span style=color:#a6e22e>sendBroadcast</span>(intent);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                ...
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> reply;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä¸­è°ƒç”¨äº† ShizukuService çš„ setBinder æ–¹æ³•ï¼Œå°† IShuzukuService ä¼ è¿›å»äº†ã€‚</p><h1 id=æœ«è¯­>æœ«è¯­<a hidden class=anchor aria-hidden=true href=#æœ«è¯­>#</a></h1><p>å®é™…ä¸Šè¿™åªåˆ†æäº†ä¸€éƒ¨åˆ†ï¼Œå…³äº ShizukuService å…·ä½“çš„å¦‚ä½•å¯åŠ¨ï¼Œè¿™ä¸ª main æ–¹æ³•æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Œå’Œå…³äº start.sh çš„ä¸€äº›é—®é¢˜ï¼Œæˆ–è®¸æœ‰ç”Ÿä¹‹å¹´æˆ‘èƒ½<del>æ°´</del>å†™å‡ºç¬¬äºŒç¯‡æ–‡ç« &mldr;</p><p>Shizuku å†…è¿˜æœ‰å¥½å¤š dalaoæ“ä½œï¼Œæˆ‘éƒ½æ²¡æœ‰å»çœ‹ï¼ŒåªæŠŠé‡è¦çš„ä¸€éƒ¨åˆ†å†™äº†ä¸‹æ¥ã€‚</p><p>æœç„¶åªæœ‰ dalaoæ‰èƒ½è¿™æ ·æ“ä½œï¼Œæˆ‘è¿˜æ˜¯ç»§ç»­èººç€å§ã€‚</p><p>Orz</p><hr><p>2020-02-04ï¼š</p><p>æ—¶éš”ä¸¤å¤©ï¼Œæˆ‘åˆå†™å‡ºäº†ç¬¬äºŒç¯‡æ–‡ç« å•¦ï¼šhttps://lcblog.cn/post/android-shizuku-theory2</p><p>å°è¯•å…·ä½“åˆ†æ Starter ç±»æ˜¯å¦‚ä½•å¯åŠ¨çš„ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://moonlab.top/tags/android/>Android</a></li></ul></footer><script src=https://comment.moonlab.top/moontalk.js></script><div id=container></div><script>(new MoonTalk).init({page_key:window.location.href,server:"https:///comment.moonlab.top",element:"#container"})</script></article></main><aside class=rightbar><div class=rightbar-categories><h3>åˆ†ç±»</h3><ul class=rightbar-categories-first-list><li><a href=https://moonlab.top/categories/programming/>Programming</a> (16)<ul class=rightbar-categories-sec-list><li><a href=/tags/embeded>Embeded</a></li><li><a href=/tags/golang>golang</a></li><li><a href=/tags/linux>Linux</a></li><li><a href=/tags/android>Android</a></li></ul></li><li><a href=https://moonlab.top/categories/reverse/>Reverse</a> (1)<ul class=rightbar-categories-sec-list><li><a href=/tags/javascript>JavaScript</a></li></ul></li><li><a href=https://moonlab.top/categories/%E5%85%B6%E4%BB%96/>å…¶ä»–</a> (5)<ul class=rightbar-categories-sec-list><li><a href=/tags/blog>blog</a></li></ul></li><li><a href=https://moonlab.top/categories/%E7%AE%97%E6%B3%95/>ç®—æ³•</a> (4)<ul class=rightbar-categories-sec-list></ul></li></ul></div></aside></div><footer class=footer><img id=mooncounter-img style="margin:0 auto;margin-bottom:6px"></img>
<script src="//counter.moonlab.top/img?name=https://moonlab.top/"></script><span>&copy; 2025 <a href=https://moonlab.top/>MoonLab</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><a href=https://www.travellings.cn/go.html rel=noopener target=_blank><img style=height:27px alt=travelling src=https://www.travellings.cn/assets/logo.svg></a></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>