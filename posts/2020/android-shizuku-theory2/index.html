<!doctype html><html lang=cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android Shizukuæºç åˆ†æ ç¬¬äºŒç¯‡ | MoonLab</title>
<meta name=keywords content="Android"><meta name=description content="æœ¬æ–‡æ·±å…¥åˆ†æäº† Shizuku çš„å¯åŠ¨è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯ Starter ç±»çš„ main æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚æ–‡ç« é¦–å…ˆå›é¡¾äº† Shizuku çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä»‹ç»äº†é€šè¿‡ adb å‘½ä»¤æ¿€æ´» ShizukuService çš„è¿‡ç¨‹ï¼Œé‡ç‚¹åˆ†æäº† start.sh è„šæœ¬çš„æ‰§è¡Œã€‚å½“ç”¨æˆ·é€šè¿‡ ShizukuManager å¯åŠ¨åº”ç”¨æ—¶ï¼Œstart.sh è„šæœ¬è¢«è°ƒç”¨ï¼Œè¯¥è„šæœ¬è´Ÿè´£è®¾ç½®ç¯å¢ƒå¹¶æ‰§è¡Œ libshizuku.so æ–‡ä»¶ã€‚æ–‡ç« è¯¦ç»†æè¿°äº† ShizukuManager åœ¨å¯åŠ¨æ—¶å¦‚ä½•å†™å…¥ start.sh æ–‡ä»¶åŠå…¶ç›¸å…³çš„ dex æ–‡ä»¶è·¯å¾„ã€‚æ¥ç€ï¼Œæ–‡ç« æ¢è®¨äº† libshizuku.so ä¸­çš„ main æ–¹æ³•ï¼Œè¯´æ˜äº†å¦‚ä½•é€šè¿‡ app_process å¯åŠ¨ Java ç±» moe.shizuku.server.Starterã€‚åœ¨ Starter ç±»çš„ main æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº† ShizukuService å®ä¾‹ï¼Œä»è€Œå®Œæˆäº† ShizukuService çš„å¯åŠ¨ã€‚æœ€åï¼Œä½œè€…æ€»ç»“äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œå¼ºè°ƒäº†ç”¨æˆ·é€šè¿‡ç®€å•çš„ adb å‘½ä»¤å¦‚ä½•è§¦å‘ä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œï¼Œæœ€ç»ˆå®ç° Shizuku çš„åŠŸèƒ½ã€‚"><meta name=author content="LingC"><link rel=canonical href=https://moonlab.top/posts/2020/android-shizuku-theory2/><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]},loader:{load:["ui/safe"]}}</script><link crossorigin=anonymous href=/assets/css/stylesheet.1ff5a7b3bb4a96bf1747dfa25e8031167d4537d7ae4b78fac2b752886047a06e.css rel="preload stylesheet" as=style><link rel=icon href=/moon.svg type=image/svg+xml><link rel=icon type=image/png sizes=16x16 href=https://moonlab.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://moonlab.top/favicon-32x32.png><link rel=apple-touch-icon href=https://moonlab.top/apple-touch-icon.png><link rel=mask-icon href=https://moonlab.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=cn href=https://moonlab.top/posts/2020/android-shizuku-theory2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Android Shizukuæºç åˆ†æ ç¬¬äºŒç¯‡"><meta property="og:description" content="æœ¬æ–‡æ·±å…¥åˆ†æäº† Shizuku çš„å¯åŠ¨è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯ Starter ç±»çš„ main æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚æ–‡ç« é¦–å…ˆå›é¡¾äº† Shizuku çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä»‹ç»äº†é€šè¿‡ adb å‘½ä»¤æ¿€æ´» ShizukuService çš„è¿‡ç¨‹ï¼Œé‡ç‚¹åˆ†æäº† start.sh è„šæœ¬çš„æ‰§è¡Œã€‚å½“ç”¨æˆ·é€šè¿‡ ShizukuManager å¯åŠ¨åº”ç”¨æ—¶ï¼Œstart.sh è„šæœ¬è¢«è°ƒç”¨ï¼Œè¯¥è„šæœ¬è´Ÿè´£è®¾ç½®ç¯å¢ƒå¹¶æ‰§è¡Œ libshizuku.so æ–‡ä»¶ã€‚æ–‡ç« è¯¦ç»†æè¿°äº† ShizukuManager åœ¨å¯åŠ¨æ—¶å¦‚ä½•å†™å…¥ start.sh æ–‡ä»¶åŠå…¶ç›¸å…³çš„ dex æ–‡ä»¶è·¯å¾„ã€‚æ¥ç€ï¼Œæ–‡ç« æ¢è®¨äº† libshizuku.so ä¸­çš„ main æ–¹æ³•ï¼Œè¯´æ˜äº†å¦‚ä½•é€šè¿‡ app_process å¯åŠ¨ Java ç±» moe.shizuku.server.Starterã€‚åœ¨ Starter ç±»çš„ main æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº† ShizukuService å®ä¾‹ï¼Œä»è€Œå®Œæˆäº† ShizukuService çš„å¯åŠ¨ã€‚æœ€åï¼Œä½œè€…æ€»ç»“äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œå¼ºè°ƒäº†ç”¨æˆ·é€šè¿‡ç®€å•çš„ adb å‘½ä»¤å¦‚ä½•è§¦å‘ä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œï¼Œæœ€ç»ˆå®ç° Shizuku çš„åŠŸèƒ½ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://moonlab.top/posts/2020/android-shizuku-theory2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-04T11:43:10+00:00"><meta property="article:modified_time" content="2020-02-04T11:43:10+00:00"><meta property="og:site_name" content="MoonLab"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android Shizukuæºç åˆ†æ ç¬¬äºŒç¯‡"><meta name=twitter:description content="æœ¬æ–‡æ·±å…¥åˆ†æäº† Shizuku çš„å¯åŠ¨è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯ Starter ç±»çš„ main æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚æ–‡ç« é¦–å…ˆå›é¡¾äº† Shizuku çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä»‹ç»äº†é€šè¿‡ adb å‘½ä»¤æ¿€æ´» ShizukuService çš„è¿‡ç¨‹ï¼Œé‡ç‚¹åˆ†æäº† start.sh è„šæœ¬çš„æ‰§è¡Œã€‚å½“ç”¨æˆ·é€šè¿‡ ShizukuManager å¯åŠ¨åº”ç”¨æ—¶ï¼Œstart.sh è„šæœ¬è¢«è°ƒç”¨ï¼Œè¯¥è„šæœ¬è´Ÿè´£è®¾ç½®ç¯å¢ƒå¹¶æ‰§è¡Œ libshizuku.so æ–‡ä»¶ã€‚æ–‡ç« è¯¦ç»†æè¿°äº† ShizukuManager åœ¨å¯åŠ¨æ—¶å¦‚ä½•å†™å…¥ start.sh æ–‡ä»¶åŠå…¶ç›¸å…³çš„ dex æ–‡ä»¶è·¯å¾„ã€‚æ¥ç€ï¼Œæ–‡ç« æ¢è®¨äº† libshizuku.so ä¸­çš„ main æ–¹æ³•ï¼Œè¯´æ˜äº†å¦‚ä½•é€šè¿‡ app_process å¯åŠ¨ Java ç±» moe.shizuku.server.Starterã€‚åœ¨ Starter ç±»çš„ main æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº† ShizukuService å®ä¾‹ï¼Œä»è€Œå®Œæˆäº† ShizukuService çš„å¯åŠ¨ã€‚æœ€åï¼Œä½œè€…æ€»ç»“äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œå¼ºè°ƒäº†ç”¨æˆ·é€šè¿‡ç®€å•çš„ adb å‘½ä»¤å¦‚ä½•è§¦å‘ä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œï¼Œæœ€ç»ˆå®ç° Shizuku çš„åŠŸèƒ½ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://moonlab.top/posts/"},{"@type":"ListItem","position":2,"name":"Android Shizukuæºç åˆ†æ ç¬¬äºŒç¯‡","item":"https://moonlab.top/posts/2020/android-shizuku-theory2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android Shizukuæºç åˆ†æ ç¬¬äºŒç¯‡","name":"Android Shizukuæºç åˆ†æ ç¬¬äºŒç¯‡","description":"æœ¬æ–‡æ·±å…¥åˆ†æäº† Shizuku çš„å¯åŠ¨è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯ Starter ç±»çš„ main æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚æ–‡ç« é¦–å…ˆå›é¡¾äº† Shizuku çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä»‹ç»äº†é€šè¿‡ adb å‘½ä»¤æ¿€æ´» ShizukuService çš„è¿‡ç¨‹ï¼Œé‡ç‚¹åˆ†æäº† start.sh è„šæœ¬çš„æ‰§è¡Œã€‚å½“ç”¨æˆ·é€šè¿‡ ShizukuManager å¯åŠ¨åº”ç”¨æ—¶ï¼Œstart.sh è„šæœ¬è¢«è°ƒç”¨ï¼Œè¯¥è„šæœ¬è´Ÿè´£è®¾ç½®ç¯å¢ƒå¹¶æ‰§è¡Œ libshizuku.so æ–‡ä»¶ã€‚æ–‡ç« è¯¦ç»†æè¿°äº† ShizukuManager åœ¨å¯åŠ¨æ—¶å¦‚ä½•å†™å…¥ start.sh æ–‡ä»¶åŠå…¶ç›¸å…³çš„ dex æ–‡ä»¶è·¯å¾„ã€‚æ¥ç€ï¼Œæ–‡ç« æ¢è®¨äº† libshizuku.so ä¸­çš„ main æ–¹æ³•ï¼Œè¯´æ˜äº†å¦‚ä½•é€šè¿‡ app_process å¯åŠ¨ Java ç±» moe.shizuku.server.Starterã€‚åœ¨ Starter ç±»çš„ main æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº† ShizukuService å®ä¾‹ï¼Œä»è€Œå®Œæˆäº† ShizukuService çš„å¯åŠ¨ã€‚æœ€åï¼Œä½œè€…æ€»ç»“äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œå¼ºè°ƒäº†ç”¨æˆ·é€šè¿‡ç®€å•çš„ adb å‘½ä»¤å¦‚ä½•è§¦å‘ä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œï¼Œæœ€ç»ˆå®ç° Shizuku çš„åŠŸèƒ½ã€‚","keywords":["Android"],"articleBody":"åˆæ˜¯å‰è¨€ ä¸Šä¸€ç¯‡çš„ Shizuku æºç åˆ†æï¼Œæˆ‘å¤§æ¦‚ä»æˆ‘ä»¬å¼€å‘çš„åº”ç”¨åˆ° ShizukuService å†åˆ° SystemService éƒ½é€šäº†ä¸€éã€‚åœ¨æ–‡ç« çš„ç»“å°¾æˆ‘åªæåˆ°äº† moe.shizuku.service åŒ…ä¸‹çš„ Starter è¿™ä¸ª Java ç±»çš„ main æ–¹æ³•å¯åŠ¨äº†æ•´ä¸ª ShizukuService ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰èƒ½æ„‰å¿«åœ°è°ƒç”¨ Shizuku çš„ APIã€‚\næˆ‘ä»¬æ¥ä¸‹æ¥è¦æ›´æ·±å…¥åˆ†æï¼Œå» Navtive å±‚çœ‹çœ‹ã€‚æˆ‘æƒ³è¦çŸ¥é“ Starter çš„ main æ–¹æ³•åˆæ˜¯è°è°ƒç”¨çš„ï¼Ÿæ€ä¹ˆè°ƒç”¨çš„ï¼Ÿ\nShizuku æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘å°±ä¸å†å¤šè¯´äº†ã€‚\nGithub: https://github.com/RikkaApps/Shizuku\nï¼ˆä¹‹åä¼šç®€å•æ¶‰åŠåˆ° Android ä¸­çš„ NDK å¼€å‘ï¼Œå’Œä¸€äº› C++ çš„å†…å®¹ï¼‰\nstart.sh å½“ç”¨æˆ·ä½¿ç”¨ ShizukuManager ï¼Œé€šè¿‡ ShizukuManager æ¿€æ´»åº”ç”¨æ—¶ï¼Œéœ€è¦å…ˆå¯åŠ¨ ShizukuService ã€‚\nè¿™é‡Œæœ‰ adb å’Œ root ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼Œæˆ‘ä»¬åªåˆ†æ adb æ–¹å¼ã€‚\nadb shell sh /sdcard/Android/data/moe.shizuku.privileged.api/files/start.sh è¿™æ¡ adb å‘½ä»¤æƒ³å¿…ç”¨è¿‡ ShizukuManager çš„äººéƒ½å¾ˆç†Ÿæ‚‰å§ï¼Ÿåªè¦åœ¨ adb ç»ˆç«¯è¾“å…¥è¿™æ¡å‘½ä»¤ï¼Œå°±èƒ½æ¿€æ´» ShizukuManagerã€‚\nè¿™æ¡å‘½ä»¤å¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨ sh è„šæœ¬ start.sh ã€‚è¿™ä¸ª start.sh åœ¨æºç ä¸­ manager æ¨¡å—çš„ raw æ–‡ä»¶å¤¹ä¸­ï¼š\nè¿™ä¸ª shell è„šæœ¬çš„å†…å®¹æ˜¯ä»€ä¹ˆæˆ‘ä»¬ç­‰ä¼šå†çœ‹ï¼Œæˆ‘ä»¬å…ˆè¦çŸ¥é“ ShizukuManager è¿™ä¸ª APP åœ¨å¯åŠ¨æ—¶å¹²äº†ä»€ä¹ˆ ï¼Œçœ‹çœ‹ Manager çš„ MainActivity çš„ onCreate æ–¹æ³•ï¼š\nprivate static boolean sWriteFilesCalled; @Override protected void onCreate(Bundle savedInstanceState) { if (!sWriteFilesCalled) { ServerLauncher.writeFiles(this, true); sWriteFilesCalled = true; } } è¿™é‡Œè°ƒç”¨äº† ServiceLauncher çš„ writeFiles æ–¹æ³•ï¼Œè®©æˆ‘ä»¬æ¥åº·åº·ï¼š\npublic static void writeFiles(Context context, boolean external) { // ä» MainActivity ä¼ å…¥çš„ external æ˜¯ true try { File out; if (external) // æ‰§è¡Œè¿™é‡Œï¼Œå¾—åˆ° /sdcard/Android/data/com.example.app/files/ out = context.getExternalFilesDir(null); else out = getParent(context); if (out == null) return; int apiVersion = Math.min(ShizukuLegacy.MAX_SDK, Build.VERSION.SDK_INT); String source = String.format(Locale.ENGLISH, \"server-v2-%d.dex\", apiVersion); // æ­¤æ—¶ i ä¸º 1 int i = external ? 1 : 0; // copyDex DEX_LEGACY_PATH[i] = copyDex(context, source, new File(out, V2_DEX_NAME)); DEX_PATH[i] = copyDex(context, \"server.dex\", new File(out, V3_DEX_NAME)); // æ³¨æ„æ³¨æ„è¿™ä¸ª writeShellFile æ–¹æ³• String command = writeShellFile(context, new File(out, \"start.sh\"), DEX_LEGACY_PATH[i], DEX_PATH[i]); // external ä¸º true ï¼Œä¸æ‰§è¡Œ if (!external) { COMMAND_ROOT = command; } } catch (IOException e) { e.printStackTrace(); } } çœ‹åˆ° writeShellFile è¿™ä¸ªæ–¹æ³•äº†å—ï¼Ÿé‡Œé¢çš„å‚æ•°æ˜¯ä¸€ä¸ª File ç±»å’Œä¸€ä¸ª â€œstart.shâ€ï¼Œè¿˜æœ‰ä¸¤ä¸ª dex æ–‡ä»¶è·¯å¾„ã€‚\nç»§ç»­çœ‹ ServiceLauncher#writeShellFileï¼š\nprivate static String writeShellFile(Context context, File out, String dexLegacy, String dex) throws IOException { if (!out.exists()) { //noinspection ResultOfMethodCallIgnored out.createNewFile(); } BufferedReader is = new BufferedReader(new InputStreamReader(context.getResources().openRawResource(R.raw.start))); PrintWriter os = new PrintWriter(new FileWriter(out)); String line; while ((line = is.readLine()) != null) { // è¿™é‡Œå°† start.sh å†™å‡ºï¼Œå¹¶æŠŠ start.sh çš„é‚£äº›æ–‡å­—æ›¿æ¢æˆè·¯å¾„å€¼ã€‚ os.println(line .replace(\"%%%STARTER_PATH%%%\", getLibPath(context, \"libshizuku.so\")) .replace(\"%%%STARTER_PARAM%%%\", getStarterParam(dexLegacy, dex)) .replace(\"%%%LIBRARY_PATH%%%\", getLibPath(context, \"libhelper.so\")) ); } os.flush(); os.close(); return \"sh \" + out.getAbsolutePath(); } è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰çœ‹çš„é‚£ä¸ª start.sh çš„å†…å®¹å—ï¼Ÿè¿™é‡Œå®é™…ä¸Šå°±æ˜¯æŠŠ raw å†…çš„ start.sh å†™å‡ºæ”¾åˆ° /sdcard/Android/data/moe.shizuku.privileged.api/filesã€‚\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆé‚£æ¡æ¿€æ´»ç”¨çš„ adb å‘½ä»¤èƒ½å¤Ÿæ‰§è¡Œï¼š\nadb shell sh /sdcard/Android/data/moe.shizuku.privileged.api/files/start.sh çœ‹åˆ°äº†å—ï¼Ÿå¦‚æœä½ å®‰è£…äº† ShizukuManager å¹¶æ‰“å¼€äº†ï¼Œä½ å¯ä»¥åœ¨ /sdcard/Android/data/moe.shizuku.privileged.api/files ç›®å½•é‡Œæ‰¾åˆ°è¿™ä¸ª start.sh å’Œä¸¤ä¸ª dex æ–‡ä»¶ã€‚\nè¿™ä¿© dex æ–‡ä»¶å°±æ˜¯é€šè¿‡ ServiceLauncher#writeFiles ç”¨ copyDex æ–¹æ³•æŠŠ assets çš„ dex å†™å‡ºåˆ°SDç›®å½•ã€‚\nåŒæ—¶ start.sh ä¸­çš„é‚£å¼€å¤´çš„ä¸‰ä¸ªå˜é‡ä¹Ÿåœ¨å†™å‡ºçš„æ—¶å€™è¢« ShizukuManager æ›¿æ¢äº†ï¼š\n#!/system/bin/sh // è¿™ä¸‰ä¸ªå˜é‡åœ¨ ShizukuManager å†™å‡ºæ—¶è¢«æ›¿æ¢äº† STARTER_PATH=\"%%%STARTER_PATH%%%\" // å¯¹åº” libshizuku.so æ–‡ä»¶è·¯å¾„ STARTER_PARAM=\"%%%STARTER_PARAM%%%\" // å¯¹åº”è°ƒç”¨ main å‡½æ•°çš„å‚æ•°ï¼Œé‡Œé¢åŒ…å«äº†é‚£ä¸¤ä¸ª dex æ–‡ä»¶çš„è·¯å¾„å’Œ token LIBRARY_PATH=\"%%%LIBRARY_PATH%%%\" // å¯¹åº” libhelper.so æ–‡ä»¶è·¯å¾„ echo \"info: start.sh begin\" if [[ -f \"$STARTER_PATH\" ]]; then rm -f /data/local/tmp/shizuku_starter // å°† libshizuku.so æ–‡ä»¶ç§»åŠ¨åˆ° // å®é™…ä¸Š /data/local/tmp/ ä¸‹çš„ shizuku_starter æ–‡ä»¶å°±æ˜¯ libshizuku.so æ–‡ä»¶ cp \"$STARTER_PATH\" /data/local/tmp/shizuku_starter // ä¿®æ”¹æƒé™ chmod 700 /data/local/tmp/shizuku_starter chown 2000 /data/local/tmp/shizuku_starter chgrp 2000 /data/local/tmp/shizuku_starter // è¿™ä¼¼ä¹æ˜¯åœ¨ä¿®æ”¹ Selinux å•¥çš„ä»€ä¹ˆä¸œè¥¿çš„å•¥å­å‘½ä»¤ chcon u:object_r:shell_data_file:s0 /data/local/tmp/shizuku_starter // è®¾ç½®ç¯å¢ƒå˜é‡ export PATH=/data/local/tmp:/system/bin:$PATH // è°ƒç”¨ shizku_starter soæ–‡ä»¶ï¼ˆåŸæ¥æ˜¯ libshizuku.soï¼‰çš„ main æ–¹æ³•ï¼Œä¼ å…¥å‚æ•° shizuku_starter ${STARTER_PARAM} $1 // è¿”å›ä¸Š shizuku_starer å†… main å‡½æ•°çš„è¿”å›å€¼ result=$? if [[ ${result} -ne 0 ]]; then echo \"info: shizuku_starter exit with non-zero value $result\" else echo \"info: shizuku_starter exit with 0\" fi else echo \"Starter file not exist, please open Shizuku Manager and try again.\" fi å½“æˆ‘ä»¬è¾“å…¥é‚£æ¡ç”¨æ¥æ¿€æ´» ShizukuManager çš„ adb å‘½ä»¤æ—¶å€™ï¼Œè¾“å‡ºæ¡†ä¼šå™¼é‡Œå•ªå•¦æ»šå‡ºä¸€å¤§å †è¾“å‡ºã€‚é‚£äº›è¾“å‡ºæ˜¯å“ªé‡Œæ¥çš„ï¼Ÿå¾ˆæ˜æ˜¾åœ¨ start.sh ä¸­æ²¡æœ‰å‡ æ¡ echo å‘½ä»¤ï¼Œåªèƒ½æ˜¯åœ¨ shizuku_starter çš„ main æ–¹æ³•é‡Œæœ‰ä»€ä¹ˆå¤§åŠ¨ä½œã€‚\nè¿™ä¸ª libshizuku.so æ–‡ä»¶çš„åŸèº«ä½ å¯ä»¥åœ¨ ShizukuManager æºç ä¸­çš„ jni æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ï¼Œæ–‡ä»¶åæ˜¯ starter.cppã€‚\næ²¡é”™ï¼Œå®ƒæ˜¯ä¸€ä¸ª C++ æ–‡ä»¶ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„ main æ–¹æ³•ï¼ˆæˆ‘ä¼šé€‚å½“åœ°è·³è¿‡ä¸€äº›ä¸ä¸»é¢˜æ— å…³çš„ä»£ç ï¼‰ï¼š\n#define SERVER_CLASS_PATH_LEGACY \"moe.shizuku.server.ShizukuServer\" #define SERVER_CLASS_PATH \"moe.shizuku.server.Starter\" int main(int argc, char **argv) { // argc æ˜¯ä¼ è¿›æ¥çš„å‚æ•°çš„æ•°é‡ï¼Œargvæ˜¯ä¼ å…¥çš„å‚æ•°çš„æ•°ç»„ã€‚é‡Œé¢åŒ…å«äº† tokenï¼Œ ä¸¤ä¸ª dec æ–‡ä»¶çš„è·¯å¾„ ... char *token = nullptr; char *_path = nullptr; char *_path_legacy = nullptr; int v2 = 1; int i; int use_shell_context = 0; // for å¾ªç¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ˜¯åœ¨å–å‡ºå‚æ•° for (i = 0; i \u003c argc; ++i) { if (strncmp(argv[i], \"--token=\", 8) == 0) { token = strdup(argv[i] + 8); } else if (strncmp(argv[i], \"--path=\", 7) == 0) { _path = strdup(argv[i] + 7); } else if (strncmp(argv[i], \"--path-legacy=\", 14) == 0) { _path_legacy = strdup(argv[i] + 14); } else if (strncmp(argv[i], \"--no-v2\", 7) == 0) { v2 = 0; } else if (strncmp(argv[i], \"--use-shell-context\", 19) == 0) { use_shell_context = 1; } } ... // check_acess ä¼šè°ƒç”¨ acess å‡½æ•°åˆ¤æ–­è·¯å¾„æ˜¯å¦æœ‰è¯»å†™æƒé™ check_access(_path, \"source dex path\"); if (v2) check_access(_path_legacy, \"source legacy dex path\"); // è¿™é‡Œæˆ‘æ˜¯æ²¡çœ‹æ‡‚çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆå»ºäº†ä¸€ä¸ª /data/local/tmp/shizuku æ–‡ä»¶å¤¹ï¼Œå°†ä¹‹å‰ _path å†…çš„æ–‡ä»¶å…¨éƒ¨ç§»åŠ¨åˆ°äº† path è¿™ä¸ªè·¯å¾„é‡Œã€‚ mkdir(\"/data/local/tmp/shizuku\", 0707); chmod(\"/data/local/tmp/shizuku\", 0707); ... // ä¸€ä¸ª char æ•°ç»„ï¼Œä¹Ÿå°±ç›¸å½“äºä¸€ä¸ª string char path[PATH_MAX], path_legacy[PATH_MAX]; // æ ¼å¼åŒ–å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä¸º path èµ‹å€¼äº† sprintf(path, \"/data/local/tmp/shizuku/%s\", basename(_path)); sprintf(path_legacy, \"/data/local/tmp/shizuku/%s\", basename(_path_legacy)); // å¼€å§‹å¤åˆ¶äº†ï¼Œå°† _path è·¯å¾„ä¸‹çš„ä¸¤ä¸ª dex ç§»åŠ¨åˆ° path è·¯å¾„ copy_if_not_exist(_path, path); if (v2) copy_if_not_exist(_path_legacy, path_legacy); check_access(path, \"dex path\"); if (v2) check_access(path_legacy, \"legacy dex path\"); printf(\"info: starter begin\\n\"); // å¼ºåˆ¶è¾“å‡ºç¼“å†²åŒºçš„ä¿¡æ¯ï¼Œå°±æ˜¯ä¸ºäº†å¿«é€Ÿè¾“å‡ºä¸Šé¢çš„ printf å†…å®¹å•¦ fflush(stdout); ... printf(\"info: starting server v3...\\n\"); fflush(stdout); // æˆ‘ä»¬é‡ç‚¹åˆ†æè¿™ä¸ª start_service å‡½æ•°ï¼Œä¼ å…¥ SERVICE_CLASS_PATH è¿™ä¸ªå¸¸é‡ï¼Œå€¼ä¸º \"moe.shizuku.server.Starter\"ï¼Œç†Ÿæ‚‰å—ï¼Ÿè¿™å°±æ˜¯åœ¨åº”ç”¨å±‚çš„ä¸»è§’å•Šï¼Œç”¨äºå¯åŠ¨ ShizukuService çš„ Java ç±»ã€‚ start_server(path, SERVER_CLASS_PATH, token, SERVER_NAME, use_shell_context); if (v2) { printf(\"info: starting server v2 (legacy)...\\n\"); fflush(stdout); start_server(path_legacy, SERVER_CLASS_PATH_LEGACY, token, SERVER_NAME_LEGACY, false); } exit_with_logcat(EXIT_SUCCESS); // starter.cpp ç»“æŸ } æ³¨é‡Šä¸Šå·²ç»å¤§æ¦‚åœ°è¯´äº†ä¸€éï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ start_service å‡½æ•°ï¼ŒåŒæ · start_service ä¹Ÿæ˜¯ starter.cpp ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼š\nstatic int start_server(const char *path, const char *main_class, const char *token, const char *nice_name, int change_context) { ... /* çœç•¥äº†å¾ˆå¤šå†…å®¹ï¼Œè¯¦ç»†å¯è‡ªå·±å»çœ‹çœ‹ Shizuku çš„æºç  */ char buf[128], class_path[PATH_MAX]; sprintf(buf, \"--nice-name=%s\", nice_name); setClasspathEnv(path); snprintf(class_path, PATH_MAX, \"-Djava.class.path=%s\", path); char *appProcessArgs[] = { // app_process æ˜¯ Android é‡Œä¸“é—¨ç”¨æ¥å¯åŠ¨ Java ç¨‹åºçš„ const_cast\u003cchar *\u003e(\"/system/bin/app_process\"), class_path, const_cast\u003cchar *\u003e(\"/system/bin\"), const_cast\u003cchar *\u003e(buf), // main_class å€¼ä¸º \"moe.shizuku.server.Starter\" const_cast\u003cchar *\u003e(main_class), const_cast\u003cchar *\u003e(token), nullptr }; // è°ƒç”¨ app_process å»è¿è¡Œ main_class if (execvp(appProcessArgs[0], appProcessArgs)) { exit_with_logcat(EXIT_FATAL_APP_PROCESS); } ... } åˆ°è¿™é‡Œæˆ‘ä»¬çš„åˆ†æå·²ç»å·®ä¸å¤šäº†ã€‚\næˆ‘ä»¬å†ä»”ç»†è¯´è¯´ app_process çš„å†…å®¹ï¼š\nè°ƒç”¨ app_process çš„è¯ï¼Œä½ éœ€è¦åœ¨å‚æ•°ä¸­æä¾› dex æ–‡ä»¶ï¼ŒåŒæ—¶å¿…é¡»è¦ä½¿ dex æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™\napp_process -Djava.class.path=dexæ–‡ä»¶å dexæ‰€å¤„çš„ç›®å½•è·¯å¾„ ä½ è¦å¯åŠ¨çš„ Java ç±»ï¼ˆæœ‰ç±»åå’ŒåŒ…åï¼‰ æˆ‘æ‰¾æ¥äº†ä¸€ä¸ªå‚æ•°åˆ—è¡¨ï¼š\nvm-options â€“ VM é€‰é¡¹ cmd-dir â€“çˆ¶ç›®å½• (/system/bin) options â€“è¿è¡Œçš„å‚æ•° : â€“zygote â€“start-system-server â€“application (api\u003e=14) â€“nice-name=nice_proc_name (api\u003e=14) start-class-name â€“åŒ…å«mainæ–¹æ³•çš„ä¸»ç±» (com.android.commands.am.Am) main-options â€“å¯åŠ¨æ—¶å€™ä¼ é€’åˆ°mainæ–¹æ³•ä¸­çš„å‚æ•° å°æ€»ç»“ ç”¨æˆ·é€šè¿‡è¾“å…¥ä¸€æ¡ adb å‘½ä»¤å»æ‰§è¡Œ start.sh æ–‡ä»¶ï¼Œstart.sh æ–‡ä»¶ä¼šæ‰§è¡Œ ShizukuManager æ—©å·²å‡†å¤‡å¥½çš„ so æ–‡ä»¶ã€‚åœ¨ so æ–‡ä»¶ä¸­ç»è¿‡ä¸€å¤§å †æ“ä½œï¼Œä¼šé€šè¿‡ app_process è¿è¡Œ Starter ç±»çš„ main æ–¹æ³•ï¼Œè€Œ Starter è¿™ä¸ª Java ç±»çš„ main æ–¹æ³•ä¼šç›´æ¥ new ä¸€ä¸ª ShizukuService ä½¿å®ƒè·‘èµ·æ¥ã€‚\nçœ‹äº†ä¸€ä¸Šåˆçš„ä»£ç ï¼Œç¿˜äº†ä¸€ä¸Šåˆçš„åœ¨é“›é“›çš„ç½‘ç»œè¯¾ã€‚\nå°¼ç›ï¼Œéƒ½å»¶é•¿å‡æœŸäº†å’Œä¸Šä¸ªå±çš„ç½‘ç»œè¯¾ã€‚\n","wordCount":"889","inLanguage":"cn","datePublished":"2020-02-04T11:43:10Z","dateModified":"2020-02-04T11:43:10Z","author":{"@type":"Person","name":"LingC"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moonlab.top/posts/2020/android-shizuku-theory2/"},"publisher":{"@type":"Organization","name":"MoonLab","logo":{"@type":"ImageObject","url":"https://moonlab.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://moonlab.top/ accesskey=h title="MoonLab (Alt + H)"><img src=/moon.svg alt aria-label=logo height=20>MoonLab</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://moonlab.top/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://moonlab.top/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://moonlab.top/search/ title=æœç´¢><span>æœç´¢</span></a></li><li><a href=https://moonlab.top/about/ title=å…³äº><span>å…³äº</span></a></li><li><a href=https://www.travellings.cn/go.html target=_blank title=å¼€å¾€><span>å¼€å¾€</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><div class=body-layout><div class=leftbar></div><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Android Shizukuæºç åˆ†æ ç¬¬äºŒç¯‡</h1><div class=post-meta><span title='2020-02-04 11:43:10 +0000 UTC'>February 4, 2020</span>&nbsp;Â·&nbsp;LingC</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e5%8f%88%e6%98%af%e5%89%8d%e8%a8%80 aria-label=åˆæ˜¯å‰è¨€>åˆæ˜¯å‰è¨€</a></li><li><a href=#startsh aria-label=start.sh>start.sh</a></li><li><a href=#%e5%b0%8f%e6%80%bb%e7%bb%93 aria-label=å°æ€»ç»“>å°æ€»ç»“</a></li></ul></div></details></div><div class=post-summary><span class=bold-text>ğŸ“¦ ç”±AIç”Ÿæˆçš„æ‘˜è¦</span><br><span class=post-summary-main>æœ¬æ–‡æ·±å…¥åˆ†æäº† Shizuku çš„å¯åŠ¨è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯ `Starter` ç±»çš„ `main` æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚æ–‡ç« é¦–å…ˆå›é¡¾äº† Shizuku çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä»‹ç»äº†é€šè¿‡ `adb` å‘½ä»¤æ¿€æ´» ShizukuService çš„è¿‡ç¨‹ï¼Œé‡ç‚¹åˆ†æäº† `start.sh` è„šæœ¬çš„æ‰§è¡Œã€‚å½“ç”¨æˆ·é€šè¿‡ ShizukuManager å¯åŠ¨åº”ç”¨æ—¶ï¼Œ`start.sh` è„šæœ¬è¢«è°ƒç”¨ï¼Œè¯¥è„šæœ¬è´Ÿè´£è®¾ç½®ç¯å¢ƒå¹¶æ‰§è¡Œ `libshizuku.so` æ–‡ä»¶ã€‚æ–‡ç« è¯¦ç»†æè¿°äº† `ShizukuManager` åœ¨å¯åŠ¨æ—¶å¦‚ä½•å†™å…¥ `start.sh` æ–‡ä»¶åŠå…¶ç›¸å…³çš„ dex æ–‡ä»¶è·¯å¾„ã€‚æ¥ç€ï¼Œæ–‡ç« æ¢è®¨äº† `libshizuku.so` ä¸­çš„ `main` æ–¹æ³•ï¼Œè¯´æ˜äº†å¦‚ä½•é€šè¿‡ `app_process` å¯åŠ¨ Java ç±» `moe.shizuku.server.Starter`ã€‚åœ¨ `Starter` ç±»çš„ `main` æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº† `ShizukuService` å®ä¾‹ï¼Œä»è€Œå®Œæˆäº† ShizukuService çš„å¯åŠ¨ã€‚æœ€åï¼Œä½œè€…æ€»ç»“äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œå¼ºè°ƒäº†ç”¨æˆ·é€šè¿‡ç®€å•çš„ `adb` å‘½ä»¤å¦‚ä½•è§¦å‘ä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œï¼Œæœ€ç»ˆå®ç° Shizuku çš„åŠŸèƒ½ã€‚</span></div><div class=post-content><h1 id=åˆæ˜¯å‰è¨€>åˆæ˜¯å‰è¨€<a hidden class=anchor aria-hidden=true href=#åˆæ˜¯å‰è¨€>#</a></h1><p>ä¸Šä¸€ç¯‡çš„ <a href=https://lcblog.cn/post/android-shizuku-theory>Shizuku æºç åˆ†æ</a>ï¼Œæˆ‘å¤§æ¦‚ä»æˆ‘ä»¬å¼€å‘çš„åº”ç”¨åˆ° ShizukuService å†åˆ° SystemService éƒ½é€šäº†ä¸€éã€‚åœ¨æ–‡ç« çš„ç»“å°¾æˆ‘åªæåˆ°äº† moe.shizuku.service åŒ…ä¸‹çš„ Starter è¿™ä¸ª Java ç±»çš„ main æ–¹æ³•å¯åŠ¨äº†æ•´ä¸ª ShizukuService ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰èƒ½æ„‰å¿«åœ°è°ƒç”¨ Shizuku çš„ APIã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥è¦æ›´æ·±å…¥åˆ†æï¼Œå» Navtive å±‚çœ‹çœ‹ã€‚æˆ‘æƒ³è¦çŸ¥é“ Starter çš„ main æ–¹æ³•åˆæ˜¯è°è°ƒç”¨çš„ï¼Ÿæ€ä¹ˆè°ƒç”¨çš„ï¼Ÿ</p><p>Shizuku æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘å°±ä¸å†å¤šè¯´äº†ã€‚</p><p>Github: <a href=https://github.com/RikkaApps/Shizuku>https://github.com/RikkaApps/Shizuku</a></p><p>ï¼ˆä¹‹åä¼šç®€å•æ¶‰åŠåˆ° Android ä¸­çš„ NDK å¼€å‘ï¼Œå’Œä¸€äº› C++ çš„å†…å®¹ï¼‰</p><h1 id=startsh>start.sh<a hidden class=anchor aria-hidden=true href=#startsh>#</a></h1><p>å½“ç”¨æˆ·ä½¿ç”¨ ShizukuManager ï¼Œé€šè¿‡ ShizukuManager æ¿€æ´»åº”ç”¨æ—¶ï¼Œéœ€è¦å…ˆå¯åŠ¨ ShizukuService ã€‚</p><p>è¿™é‡Œæœ‰ adb å’Œ root ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼Œæˆ‘ä»¬åªåˆ†æ adb æ–¹å¼ã€‚</p><pre tabindex=0><code>adb shell sh /sdcard/Android/data/moe.shizuku.privileged.api/files/start.sh
</code></pre><p>è¿™æ¡ adb å‘½ä»¤æƒ³å¿…ç”¨è¿‡ ShizukuManager çš„äººéƒ½å¾ˆç†Ÿæ‚‰å§ï¼Ÿåªè¦åœ¨ adb ç»ˆç«¯è¾“å…¥è¿™æ¡å‘½ä»¤ï¼Œå°±èƒ½æ¿€æ´» ShizukuManagerã€‚</p><p>è¿™æ¡å‘½ä»¤å¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨ sh è„šæœ¬ start.sh ã€‚è¿™ä¸ª start.sh åœ¨æºç ä¸­ manager æ¨¡å—çš„ raw æ–‡ä»¶å¤¹ä¸­ï¼š</p><p>è¿™ä¸ª shell è„šæœ¬çš„å†…å®¹æ˜¯ä»€ä¹ˆæˆ‘ä»¬ç­‰ä¼šå†çœ‹ï¼Œæˆ‘ä»¬å…ˆè¦çŸ¥é“ ShizukuManager è¿™ä¸ª APP åœ¨å¯åŠ¨æ—¶å¹²äº†ä»€ä¹ˆ ï¼Œçœ‹çœ‹ Manager çš„ MainActivity çš„ onCreate æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> sWriteFilesCalled;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onCreate</span>(Bundle savedInstanceState) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>sWriteFilesCalled) {
</span></span><span style=display:flex><span>            ServerLauncher.<span style=color:#a6e22e>writeFiles</span>(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>            sWriteFilesCalled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    	}
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>è¿™é‡Œè°ƒç”¨äº† ServiceLauncher çš„ writeFiles æ–¹æ³•ï¼Œè®©æˆ‘ä»¬æ¥åº·åº·ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeFiles</span>(Context context, <span style=color:#66d9ef>boolean</span> external) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä» MainActivity ä¼ å…¥çš„ external æ˜¯ true</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            File out;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (external)
</span></span><span style=display:flex><span>                <span style=color:#75715e>// æ‰§è¡Œè¿™é‡Œï¼Œå¾—åˆ° /sdcard/Android/data/com.example.app/files/</span>
</span></span><span style=display:flex><span>                out <span style=color:#f92672>=</span> context.<span style=color:#a6e22e>getExternalFilesDir</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                out <span style=color:#f92672>=</span> getParent(context);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (out <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> apiVersion <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>min</span>(ShizukuLegacy.<span style=color:#a6e22e>MAX_SDK</span>, Build.<span style=color:#a6e22e>VERSION</span>.<span style=color:#a6e22e>SDK_INT</span>);
</span></span><span style=display:flex><span>            String source <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>format</span>(Locale.<span style=color:#a6e22e>ENGLISH</span>, <span style=color:#e6db74>&#34;server-v2-%d.dex&#34;</span>, apiVersion);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ­¤æ—¶ i ä¸º 1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> external <span style=color:#f92672>?</span> 1 : 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// copyDex</span>
</span></span><span style=display:flex><span>            DEX_LEGACY_PATH<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> copyDex(context, source, <span style=color:#66d9ef>new</span> File(out, V2_DEX_NAME));
</span></span><span style=display:flex><span>            DEX_PATH<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> copyDex(context, <span style=color:#e6db74>&#34;server.dex&#34;</span>, <span style=color:#66d9ef>new</span> File(out, V3_DEX_NAME));
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ³¨æ„æ³¨æ„è¿™ä¸ª writeShellFile æ–¹æ³•</span>
</span></span><span style=display:flex><span>            String command <span style=color:#f92672>=</span> writeShellFile(context, <span style=color:#66d9ef>new</span> File(out, <span style=color:#e6db74>&#34;start.sh&#34;</span>), DEX_LEGACY_PATH<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>, DEX_PATH<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// external ä¸º true ï¼Œä¸æ‰§è¡Œ</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>external) {
</span></span><span style=display:flex><span>                COMMAND_ROOT <span style=color:#f92672>=</span> command;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>çœ‹åˆ° writeShellFile è¿™ä¸ªæ–¹æ³•äº†å—ï¼Ÿé‡Œé¢çš„å‚æ•°æ˜¯ä¸€ä¸ª File ç±»å’Œä¸€ä¸ª &ldquo;start.sh&rdquo;ï¼Œè¿˜æœ‰ä¸¤ä¸ª dex æ–‡ä»¶è·¯å¾„ã€‚</p><p>ç»§ç»­çœ‹ ServiceLauncher#writeShellFileï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>writeShellFile</span>(Context context, File out, String dexLegacy, String dex) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>out.<span style=color:#a6e22e>exists</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>//noinspection ResultOfMethodCallIgnored</span>
</span></span><span style=display:flex><span>            out.<span style=color:#a6e22e>createNewFile</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        BufferedReader is <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedReader(<span style=color:#66d9ef>new</span> InputStreamReader(context.<span style=color:#a6e22e>getResources</span>().<span style=color:#a6e22e>openRawResource</span>(R.<span style=color:#a6e22e>raw</span>.<span style=color:#a6e22e>start</span>)));
</span></span><span style=display:flex><span>        PrintWriter os <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PrintWriter(<span style=color:#66d9ef>new</span> FileWriter(out));
</span></span><span style=display:flex><span>        String line;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> ((line <span style=color:#f92672>=</span> is.<span style=color:#a6e22e>readLine</span>()) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è¿™é‡Œå°† start.sh å†™å‡ºï¼Œå¹¶æŠŠ start.sh çš„é‚£äº›æ–‡å­—æ›¿æ¢æˆè·¯å¾„å€¼ã€‚</span>
</span></span><span style=display:flex><span>            os.<span style=color:#a6e22e>println</span>(line
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;%%%STARTER_PATH%%%&#34;</span>, getLibPath(context, <span style=color:#e6db74>&#34;libshizuku.so&#34;</span>))
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;%%%STARTER_PARAM%%%&#34;</span>, getStarterParam(dexLegacy, dex))
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;%%%LIBRARY_PATH%%%&#34;</span>, getLibPath(context, <span style=color:#e6db74>&#34;libhelper.so&#34;</span>))
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        os.<span style=color:#a6e22e>flush</span>();
</span></span><span style=display:flex><span>        os.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;sh &#34;</span> <span style=color:#f92672>+</span> out.<span style=color:#a6e22e>getAbsolutePath</span>();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰çœ‹çš„é‚£ä¸ª start.sh çš„å†…å®¹å—ï¼Ÿè¿™é‡Œå®é™…ä¸Šå°±æ˜¯æŠŠ raw å†…çš„ start.sh å†™å‡ºæ”¾åˆ° /sdcard/Android/data/moe.shizuku.privileged.api/filesã€‚</p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé‚£æ¡æ¿€æ´»ç”¨çš„ adb å‘½ä»¤èƒ½å¤Ÿæ‰§è¡Œï¼š</p><pre tabindex=0><code>adb shell sh /sdcard/Android/data/moe.shizuku.privileged.api/files/start.sh
</code></pre><p>çœ‹åˆ°äº†å—ï¼Ÿå¦‚æœä½ å®‰è£…äº† ShizukuManager å¹¶æ‰“å¼€äº†ï¼Œä½ å¯ä»¥åœ¨ /sdcard/Android/data/moe.shizuku.privileged.api/files ç›®å½•é‡Œæ‰¾åˆ°è¿™ä¸ª start.sh å’Œä¸¤ä¸ª dex æ–‡ä»¶ã€‚</p><p>è¿™ä¿© dex æ–‡ä»¶å°±æ˜¯é€šè¿‡ ServiceLauncher#writeFiles ç”¨ copyDex æ–¹æ³•æŠŠ assets çš„ dex å†™å‡ºåˆ°SDç›®å½•ã€‚</p><p>åŒæ—¶ start.sh ä¸­çš„é‚£å¼€å¤´çš„ä¸‰ä¸ªå˜é‡ä¹Ÿåœ¨å†™å‡ºçš„æ—¶å€™è¢« ShizukuManager æ›¿æ¢äº†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/system/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>// è¿™ä¸‰ä¸ªå˜é‡åœ¨ ShizukuManager å†™å‡ºæ—¶è¢«æ›¿æ¢äº†
</span></span><span style=display:flex><span>STARTER_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;%%%STARTER_PATH%%%&#34;</span> // å¯¹åº” libshizuku.so æ–‡ä»¶è·¯å¾„
</span></span><span style=display:flex><span>STARTER_PARAM<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;%%%STARTER_PARAM%%%&#34;</span> // å¯¹åº”è°ƒç”¨ main å‡½æ•°çš„å‚æ•°ï¼Œé‡Œé¢åŒ…å«äº†é‚£ä¸¤ä¸ª dex æ–‡ä»¶çš„è·¯å¾„å’Œ token 
</span></span><span style=display:flex><span>LIBRARY_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;%%%LIBRARY_PATH%%%&#34;</span> // å¯¹åº” libhelper.so æ–‡ä»¶è·¯å¾„
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;info: start.sh begin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -f <span style=color:#e6db74>&#34;</span>$STARTER_PATH<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    rm -f /data/local/tmp/shizuku_starter
</span></span><span style=display:flex><span>    // å°† libshizuku.so æ–‡ä»¶ç§»åŠ¨åˆ°
</span></span><span style=display:flex><span>    // å®é™…ä¸Š /data/local/tmp/ ä¸‹çš„ shizuku_starter æ–‡ä»¶å°±æ˜¯ libshizuku.so æ–‡ä»¶ 
</span></span><span style=display:flex><span>    cp <span style=color:#e6db74>&#34;</span>$STARTER_PATH<span style=color:#e6db74>&#34;</span> /data/local/tmp/shizuku_starter
</span></span><span style=display:flex><span>    // ä¿®æ”¹æƒé™
</span></span><span style=display:flex><span>    chmod <span style=color:#ae81ff>700</span> /data/local/tmp/shizuku_starter
</span></span><span style=display:flex><span>    chown <span style=color:#ae81ff>2000</span> /data/local/tmp/shizuku_starter
</span></span><span style=display:flex><span>    chgrp <span style=color:#ae81ff>2000</span> /data/local/tmp/shizuku_starter
</span></span><span style=display:flex><span>    // è¿™ä¼¼ä¹æ˜¯åœ¨ä¿®æ”¹ Selinux å•¥çš„ä»€ä¹ˆä¸œè¥¿çš„å•¥å­å‘½ä»¤
</span></span><span style=display:flex><span>    chcon u:object_r:shell_data_file:s0 /data/local/tmp/shizuku_starter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	// è®¾ç½®ç¯å¢ƒå˜é‡
</span></span><span style=display:flex><span>    export PATH<span style=color:#f92672>=</span>/data/local/tmp:/system/bin:$PATH
</span></span><span style=display:flex><span>    // è°ƒç”¨ shizku_starter soæ–‡ä»¶ï¼ˆåŸæ¥æ˜¯ libshizuku.soï¼‰çš„ main æ–¹æ³•ï¼Œä¼ å…¥å‚æ•°
</span></span><span style=display:flex><span>    shizuku_starter <span style=color:#e6db74>${</span>STARTER_PARAM<span style=color:#e6db74>}</span> $1
</span></span><span style=display:flex><span>    // è¿”å›ä¸Š shizuku_starer å†… main å‡½æ•°çš„è¿”å›å€¼
</span></span><span style=display:flex><span>    result<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>result<span style=color:#e6db74>}</span> -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;info: shizuku_starter exit with non-zero value </span>$result<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;info: shizuku_starter exit with 0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Starter file not exist, please open Shizuku Manager and try again.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>å½“æˆ‘ä»¬è¾“å…¥é‚£æ¡ç”¨æ¥æ¿€æ´» ShizukuManager çš„ adb å‘½ä»¤æ—¶å€™ï¼Œè¾“å‡ºæ¡†ä¼šå™¼é‡Œå•ªå•¦æ»šå‡ºä¸€å¤§å †è¾“å‡ºã€‚é‚£äº›è¾“å‡ºæ˜¯å“ªé‡Œæ¥çš„ï¼Ÿå¾ˆæ˜æ˜¾åœ¨ start.sh ä¸­æ²¡æœ‰å‡ æ¡ echo å‘½ä»¤ï¼Œåªèƒ½æ˜¯åœ¨ shizuku_starter çš„ main æ–¹æ³•é‡Œæœ‰ä»€ä¹ˆå¤§åŠ¨ä½œã€‚</p><p>è¿™ä¸ª libshizuku.so æ–‡ä»¶çš„åŸèº«ä½ å¯ä»¥åœ¨ ShizukuManager æºç ä¸­çš„ jni æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ï¼Œæ–‡ä»¶åæ˜¯ starter.cppã€‚</p><p>æ²¡é”™ï¼Œå®ƒæ˜¯ä¸€ä¸ª C++ æ–‡ä»¶ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„ main æ–¹æ³•ï¼ˆæˆ‘ä¼šé€‚å½“åœ°è·³è¿‡ä¸€äº›ä¸ä¸»é¢˜æ— å…³çš„ä»£ç ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#define SERVER_CLASS_PATH_LEGACY &#34;moe.shizuku.server.ShizukuServer&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define SERVER_CLASS_PATH &#34;moe.shizuku.server.Starter&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// argc æ˜¯ä¼ è¿›æ¥çš„å‚æ•°çš„æ•°é‡ï¼Œargvæ˜¯ä¼ å…¥çš„å‚æ•°çš„æ•°ç»„ã€‚é‡Œé¢åŒ…å«äº† tokenï¼Œ ä¸¤ä¸ª dec æ–‡ä»¶çš„è·¯å¾„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>token <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>_path <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>_path_legacy <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> v2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> use_shell_context <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// for å¾ªç¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ˜¯åœ¨å–å‡ºå‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> argc; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (strncmp(argv[i], <span style=color:#e6db74>&#34;--token=&#34;</span>, <span style=color:#ae81ff>8</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> strdup(argv[i] <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strncmp(argv[i], <span style=color:#e6db74>&#34;--path=&#34;</span>, <span style=color:#ae81ff>7</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            _path <span style=color:#f92672>=</span> strdup(argv[i] <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strncmp(argv[i], <span style=color:#e6db74>&#34;--path-legacy=&#34;</span>, <span style=color:#ae81ff>14</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            _path_legacy <span style=color:#f92672>=</span> strdup(argv[i] <span style=color:#f92672>+</span> <span style=color:#ae81ff>14</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strncmp(argv[i], <span style=color:#e6db74>&#34;--no-v2&#34;</span>, <span style=color:#ae81ff>7</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            v2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (strncmp(argv[i], <span style=color:#e6db74>&#34;--use-shell-context&#34;</span>, <span style=color:#ae81ff>19</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            use_shell_context <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e>// check_acess ä¼šè°ƒç”¨ acess å‡½æ•°åˆ¤æ–­è·¯å¾„æ˜¯å¦æœ‰è¯»å†™æƒé™
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    check_access(_path, <span style=color:#e6db74>&#34;source dex path&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (v2) check_access(_path_legacy, <span style=color:#e6db74>&#34;source legacy dex path&#34;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿™é‡Œæˆ‘æ˜¯æ²¡çœ‹æ‡‚çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆå»ºäº†ä¸€ä¸ª /data/local/tmp/shizuku æ–‡ä»¶å¤¹ï¼Œå°†ä¹‹å‰ _path å†…çš„æ–‡ä»¶å…¨éƒ¨ç§»åŠ¨åˆ°äº† path è¿™ä¸ªè·¯å¾„é‡Œã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mkdir(<span style=color:#e6db74>&#34;/data/local/tmp/shizuku&#34;</span>, <span style=color:#ae81ff>0707</span>);
</span></span><span style=display:flex><span>    chmod(<span style=color:#e6db74>&#34;/data/local/tmp/shizuku&#34;</span>, <span style=color:#ae81ff>0707</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸€ä¸ª char æ•°ç»„ï¼Œä¹Ÿå°±ç›¸å½“äºä¸€ä¸ª string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span> path[PATH_MAX], path_legacy[PATH_MAX];
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ ¼å¼åŒ–å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä¸º path èµ‹å€¼äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    sprintf(path, <span style=color:#e6db74>&#34;/data/local/tmp/shizuku/%s&#34;</span>, basename(_path));
</span></span><span style=display:flex><span>    sprintf(path_legacy, <span style=color:#e6db74>&#34;/data/local/tmp/shizuku/%s&#34;</span>, basename(_path_legacy));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¼€å§‹å¤åˆ¶äº†ï¼Œå°† _path è·¯å¾„ä¸‹çš„ä¸¤ä¸ª dex ç§»åŠ¨åˆ° path è·¯å¾„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    copy_if_not_exist(_path, path);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (v2) copy_if_not_exist(_path_legacy, path_legacy);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    check_access(path, <span style=color:#e6db74>&#34;dex path&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (v2) check_access(path_legacy, <span style=color:#e6db74>&#34;legacy dex path&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;info: starter begin</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¼ºåˆ¶è¾“å‡ºç¼“å†²åŒºçš„ä¿¡æ¯ï¼Œå°±æ˜¯ä¸ºäº†å¿«é€Ÿè¾“å‡ºä¸Šé¢çš„ printf å†…å®¹å•¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    fflush(stdout); 
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;info: starting server v3...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    fflush(stdout);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æˆ‘ä»¬é‡ç‚¹åˆ†æè¿™ä¸ª start_service å‡½æ•°ï¼Œä¼ å…¥ SERVICE_CLASS_PATH è¿™ä¸ªå¸¸é‡ï¼Œå€¼ä¸º &#34;moe.shizuku.server.Starter&#34;ï¼Œç†Ÿæ‚‰å—ï¼Ÿè¿™å°±æ˜¯åœ¨åº”ç”¨å±‚çš„ä¸»è§’å•Šï¼Œç”¨äºå¯åŠ¨ ShizukuService çš„ Java ç±»ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    start_server(path, SERVER_CLASS_PATH, token, SERVER_NAME, use_shell_context);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (v2) {
</span></span><span style=display:flex><span>        printf(<span style=color:#e6db74>&#34;info: starting server v2 (legacy)...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        fflush(stdout);
</span></span><span style=display:flex><span>        start_server(path_legacy, SERVER_CLASS_PATH_LEGACY, token, SERVER_NAME_LEGACY, false);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    exit_with_logcat(EXIT_SUCCESS);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// starter.cpp ç»“æŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>æ³¨é‡Šä¸Šå·²ç»å¤§æ¦‚åœ°è¯´äº†ä¸€éï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ start_service å‡½æ•°ï¼ŒåŒæ · start_service ä¹Ÿæ˜¯ starter.cpp ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>start_server</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>main_class, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>token,
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>nice_name, <span style=color:#66d9ef>int</span> change_context) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* çœç•¥äº†å¾ˆå¤šå†…å®¹ï¼Œè¯¦ç»†å¯è‡ªå·±å»çœ‹çœ‹ Shizuku çš„æºç  */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>128</span>], class_path[PATH_MAX];
</span></span><span style=display:flex><span>    sprintf(buf, <span style=color:#e6db74>&#34;--nice-name=%s&#34;</span>, nice_name);
</span></span><span style=display:flex><span>    setClasspathEnv(path);
</span></span><span style=display:flex><span>    snprintf(class_path, PATH_MAX, <span style=color:#e6db74>&#34;-Djava.class.path=%s&#34;</span>, path);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>appProcessArgs[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// app_process æ˜¯ Android é‡Œä¸“é—¨ç”¨æ¥å¯åŠ¨ Java ç¨‹åºçš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>(<span style=color:#e6db74>&#34;/system/bin/app_process&#34;</span>),
</span></span><span style=display:flex><span>        class_path,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>(<span style=color:#e6db74>&#34;/system/bin&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>(buf),
</span></span><span style=display:flex><span>        <span style=color:#75715e>// main_class å€¼ä¸º &#34;moe.shizuku.server.Starter&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>(main_class),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*&gt;</span>(token),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>nullptr</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è°ƒç”¨ app_process å»è¿è¡Œ main_class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (execvp(appProcessArgs[<span style=color:#ae81ff>0</span>], appProcessArgs)) {
</span></span><span style=display:flex><span>        exit_with_logcat(EXIT_FATAL_APP_PROCESS);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„åˆ†æå·²ç»å·®ä¸å¤šäº†ã€‚</p><p>æˆ‘ä»¬å†ä»”ç»†è¯´è¯´ app_process çš„å†…å®¹ï¼š</p><p>è°ƒç”¨ app_process çš„è¯ï¼Œä½ éœ€è¦åœ¨å‚æ•°ä¸­æä¾› dex æ–‡ä»¶ï¼ŒåŒæ—¶å¿…é¡»è¦ä½¿ dex æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>app_process -Djava.class.path=dexæ–‡ä»¶å dexæ‰€å¤„çš„ç›®å½•è·¯å¾„ <span style=color:#960050;background-color:#1e0010>ä½ è¦å¯åŠ¨çš„</span> Java <span style=color:#960050;background-color:#1e0010>ç±»ï¼ˆæœ‰ç±»åå’ŒåŒ…åï¼‰</span>
</span></span></code></pre></div><p>æˆ‘æ‰¾æ¥äº†ä¸€ä¸ªå‚æ•°åˆ—è¡¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vm-options â€“ VM é€‰é¡¹
</span></span><span style=display:flex><span>cmd-dir â€“çˆ¶ç›®å½• <span style=color:#f92672>(</span>/system/bin<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>options â€“è¿è¡Œçš„å‚æ•° :
</span></span><span style=display:flex><span>    â€“zygote
</span></span><span style=display:flex><span>    â€“start-system-server
</span></span><span style=display:flex><span>    â€“application <span style=color:#f92672>(</span>api&gt;<span style=color:#f92672>=</span>14<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    â€“nice-name<span style=color:#f92672>=</span>nice_proc_name <span style=color:#f92672>(</span>api&gt;<span style=color:#f92672>=</span>14<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>start-class-name â€“åŒ…å«mainæ–¹æ³•çš„ä¸»ç±»  <span style=color:#f92672>(</span>com.android.commands.am.Am<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>main-options â€“å¯åŠ¨æ—¶å€™ä¼ é€’åˆ°mainæ–¹æ³•ä¸­çš„å‚æ•°
</span></span></code></pre></div><h1 id=å°æ€»ç»“>å°æ€»ç»“<a hidden class=anchor aria-hidden=true href=#å°æ€»ç»“>#</a></h1><p>ç”¨æˆ·é€šè¿‡è¾“å…¥ä¸€æ¡ adb å‘½ä»¤å»æ‰§è¡Œ start.sh æ–‡ä»¶ï¼Œstart.sh æ–‡ä»¶ä¼šæ‰§è¡Œ ShizukuManager æ—©å·²å‡†å¤‡å¥½çš„ so æ–‡ä»¶ã€‚åœ¨ so æ–‡ä»¶ä¸­ç»è¿‡ä¸€å¤§å †æ“ä½œï¼Œä¼šé€šè¿‡ app_process è¿è¡Œ Starter ç±»çš„ main æ–¹æ³•ï¼Œè€Œ Starter è¿™ä¸ª Java ç±»çš„ main æ–¹æ³•ä¼šç›´æ¥ new ä¸€ä¸ª ShizukuService ä½¿å®ƒè·‘èµ·æ¥ã€‚</p><p>çœ‹äº†ä¸€ä¸Šåˆçš„ä»£ç ï¼Œç¿˜äº†ä¸€ä¸Šåˆçš„åœ¨é“›é“›çš„ç½‘ç»œè¯¾ã€‚</p><p>å°¼ç›ï¼Œéƒ½å»¶é•¿å‡æœŸäº†å’Œä¸Šä¸ªå±çš„ç½‘ç»œè¯¾ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://moonlab.top/tags/android/>Android</a></li></ul></footer><script src=https://comment.moonlab.top/moontalk.js></script><div id=container></div><script>(new MoonTalk).init({page_key:window.location.href,server:"https:///comment.moonlab.top",element:"#container"})</script></article></main><aside class=rightbar><div class=rightbar-categories><h3>åˆ†ç±»</h3><ul class=rightbar-categories-first-list><li><a href=https://moonlab.top/categories/programming/>Programming</a> (16)<ul class=rightbar-categories-sec-list><li><a href=/tags/embeded>Embeded</a></li><li><a href=/tags/golang>golang</a></li><li><a href=/tags/linux>Linux</a></li><li><a href=/tags/android>Android</a></li></ul></li><li><a href=https://moonlab.top/categories/reverse/>Reverse</a> (1)<ul class=rightbar-categories-sec-list><li><a href=/tags/javascript>JavaScript</a></li></ul></li><li><a href=https://moonlab.top/categories/%E5%85%B6%E4%BB%96/>å…¶ä»–</a> (5)<ul class=rightbar-categories-sec-list><li><a href=/tags/blog>blog</a></li></ul></li><li><a href=https://moonlab.top/categories/%E7%AE%97%E6%B3%95/>ç®—æ³•</a> (4)<ul class=rightbar-categories-sec-list></ul></li></ul></div></aside></div><footer class=footer><img id=mooncounter-img style="margin:0 auto;margin-bottom:6px"></img>
<script src="//counter.moonlab.top/img?name=https://moonlab.top/"></script><span>&copy; 2025 <a href=https://moonlab.top/>MoonLab</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><a href=https://www.travellings.cn/go.html rel=noopener target=_blank><img style=height:27px alt=travelling src=https://www.travellings.cn/assets/logo.svg></a></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>